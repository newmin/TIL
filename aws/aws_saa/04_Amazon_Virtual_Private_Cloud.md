# Amazon Virtual Private Cloud
#TIL/aws/SAA

---

## Amazon VPC

Amazon VPC는 EC2의 네트워크 계층이며, EC2 인스턴스를 비롯한 여러 AWS 서비스에 네트워크 리소스를 담을 수 있는 가상 네트워크다.  
모든 VPC는 기본적으로 다른 모든 네트워크와 격리돼 있지만, 필요할 때는 인터넷 및 다른 VPC 등과 연결할 수 있다.  

VPC는 한 AWS 리전 안에서만 존재할 수 있으며, 한 리전에 만든 VPC는 다른 리전에서는 보이지 않는다.  
하나의 계정에 여러 VPC를 둘 수 있고 단일 리전에 여러 VPC를 만들 수 있다.  


## VPC CIDR 블록

VPC는 하나 이상의 연속적 IP 주소 범위로 구성되며, CIDR(Classless Inter Domain Routing) 블록으로 표시한다.  
VPC CIDR 접두사 길이는 /16부터 /28까지다.  
IP는 IPv4의 축약어로 유효한 접두사 길이는 /0부터 /32까지다.  

- 10.0.0.0 - 10.255.255.255 (10.0.0.0/8)
- 172.16.0.0 - 172.31.255.255 (172.16.0.0/12)
- 192.168.0.0 - 192.168.255.255 (192.168.0.0/16)


### 보조 CIDR 블록

VPC를 만든 후에도 보조 CIDR 블록을 지정할 수 있다.  
보조 CIDR 블록은 기본 CIDR 주소 범위나 퍼블릭에서 라우팅이 가능한 범위 내에서 생성돼야 하고, 기본 블록 또는 다른 보조 블록과 겹치지 않아야 한다.  


### IPv6 CIDR 블록

VPC에 IPv6 CIDR을 할당할 수 있으나, IP 접두사를 지정할 수 있는 기본 CIDR과는 달리 IPv6에서는 CIDR을 지정할 수 없다.  
그러나 AWS에 요청을 하면 가능하다.  
예를 들어 CIDR 2600:1f18:2551:8900/56과 같고, 접두사 길이는 항상 /56이다.  


## 서브넷

서브넷은 VPC 내 논리 컨테이너로서 EC2 인스턴스를 배치하는 장소다.  
인스턴스를 서로 격리하고, 인스턴스 간 트래픽 흐름을 제어하고, 인스턴스를 기능별로 모을 수 있다.  

인스턴스는 서브넷 안에 있어야 한다.  
그리고 한 VPC에서 다른 VPC로 인스턴스를 옮길 수 없다.  


### 서브넷 CIDR 블록

서브넷의 CIDR은 VPC CIDR의 일부이면서, VPC 내에서 고유해야 한다.  
AWS는 모든 서브넷에서 처음 4개 IP 주소와 마지막 IP 주소를 예약하며, 이 주소는 인스턴스에 할당할 수 없다.  

VPC는 보조 CIDR을 가질 수 있지만, 서브넷에는 하나의 CIDR만 있다.  
VPC에 기본 CIDR과 보조 CIDR이 있는 경우, 그 중 하나에서 서브넷 CIDR을 생성할 수 있다.  


### 가용 영역

서브넷은 하나의 가용 영역(AZ, Availabiliy Zone) 내에서만 존재할 수 있다.  
AWS 리전의 가용 영역들은 서로 프라이빗으로 연결돼 있으며, 한 가용 영역에 장애가 발생하더라도 다른 영역에 장애의 영향이 미치지 않도록 설계됐다.  

서로 다른 가용 영역에 서브넷을 하나씩 만든 다음 인스턴스를 각각 서브넷에 분산해서 만들면, 애플리케이션은 복원성을 확보할 수 있다.  


## 탄력적 네트워크 인터페이스

탄력적 네트워크 인터페이스(ENI, Elastic Network Interface)를 사용하면 인스턴스가 AWS 서비스, 다른 인스턴스, 온프레미스 서버, 인터넷 등 다른 네트워크 리소스와 통신할 수 있다.  
모든 인스턴스에는 기본 ENI가 있어야 하며 이 인터페이스는 하나의 서브넷에만 연결된다.  


### 기본 프라이빗 주소와 보조 프라이빗 IP 주소

각 인스턴스는 기본 프라이빗 IP 주소를 가지고 있어야 하는데, 그 주소는 서브넷 CIDR에서 지정한 범위 내 주소여야 한다.  


### 탄력적 네트워크 인터페이스 연결

ENI는 인스턴스와 독립적으로 존재할 수 있는데, 먼저 ENI를 생성하고 나중에 인스턴스에 연결할 수 있다.  
기존 ENI를 가져와서 기존 인스턴스에 보조 ENI로 연결할 수 있으며, 장애가 있는 인스턴스에서 ENI를 분리해 작동하고 있는 다른 인스턴스에 연결하면 트래픽을 장애 인스턴스에서 정상 인스턴스로 전환할 수 있다.  


## 인터넷 게이트웨이

인터넷 게이트웨이는 퍼블릭 IP 주소를 할당받은 인스턴스가 인터넷과 연결돼서 인터넷으로부터 요청을 수신하는 기능을 제공한다.  
VPC에는 하나의 게이트웨이만 연결할 수 있다.  

인터넷 게이트웨이에는 관리형 IP 주소나 네트워크 인터페이스가 없는 대신, 식별을 위해 AWS 리소스 ID가 할당된다.  
리소스 ID는 igw-로 시작하며 그 뒤에 영숫자 문자열이 온다.  


## 라우팅 테이블

각 라우팅 테이블은 하나 이상의 라우팅과 하나 이상의 서브넷 연결로 구성되며, 기존의 라우터와 거의 같은 방식으로 여러 서브넷에 연결돼 있다.  
VPC를 생성하면 기본 라우팅 테이블을 자동으로 만들고 해당 VPC의 모든 서브넷과 연결한다.  

모든 서브넷은 라우팅 테이블에 자동으로 연결된다.  


### 라우팅

라우팅은 라우팅 테이블과 연결된 서브넷 내 인스턴스에서 트래픽을 전달하는 방법을 결정한다.  

다음과 같은 요소를 제공해야 한다.  

- 대상 주소
	- CIDR 표기법의 IP 접두사여야 한다.
- 대상
	- CIDR은 사용할 수 없으며, 인터넷 게이트웨이, ENI 등의 AWS 네트워크 리소스가 지정돼야 한다.

라우팅 테이블에는 같은 VPC에 있는 인스턴스 간에 통신할 수 있게 하는 로컬 라우팅(LOCAL)이 필수적으로 포함된다.  


### 기본 라우팅

인스턴스가 인터넷에 액세스하게 하려면 인터넷 게이트웨이를 가리키는 기본 라우팅을 생성해야 한다.  
인터넷 게이트웨이를 가리키는 기본 라우팅이 포함된 라우팅 테이블과 연결된 서브넷을 **퍼블릭 서브넷**이라고 한다.  

반면 프라이빗 서브넷은 기본 라우팅을 포함하지 않는다.  









































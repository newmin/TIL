# 04. Amazon Virtual Private Cloud
#TIL/aws/SAA

---

## Amazon VPC

Amazon VPC는 EC2의 네트워크 계층이며, EC2 인스턴스를 비롯한 여러 AWS 서비스에 네트워크 리소스를 담을 수 있는 가상 네트워크다.  
모든 VPC는 기본적으로 다른 모든 네트워크와 격리돼 있지만, 필요할 때는 인터넷 및 다른 VPC 등과 연결할 수 있다.  

VPC는 한 AWS 리전 안에서만 존재할 수 있으며, 한 리전에 만든 VPC는 다른 리전에서는 보이지 않는다.  
하나의 계정에 여러 VPC를 둘 수 있고 단일 리전에 여러 VPC를 만들 수 있다.  


## VPC CIDR 블록

VPC는 하나 이상의 연속적 IP 주소 범위로 구성되며, CIDR(Classless Inter Domain Routing) 블록으로 표시한다.  
VPC CIDR 접두사 길이는 /16부터 /28까지다.  
IP는 IPv4의 축약어로 유효한 접두사 길이는 /0부터 /32까지다.  

- 10.0.0.0 - 10.255.255.255 (10.0.0.0/8)
- 172.16.0.0 - 172.31.255.255 (172.16.0.0/12)
- 192.168.0.0 - 192.168.255.255 (192.168.0.0/16)


### 보조 CIDR 블록

VPC를 만든 후에도 보조 CIDR 블록을 지정할 수 있다.  
보조 CIDR 블록은 기본 CIDR 주소 범위나 퍼블릭에서 라우팅이 가능한 범위 내에서 생성돼야 하고, 기본 블록 또는 다른 보조 블록과 겹치지 않아야 한다.  


### IPv6 CIDR 블록

VPC에 IPv6 CIDR을 할당할 수 있으나, IP 접두사를 지정할 수 있는 기본 CIDR과는 달리 IPv6에서는 CIDR을 지정할 수 없다.  
그러나 AWS에 요청을 하면 가능하다.  
예를 들어 CIDR 2600:1f18:2551:8900/56과 같고, 접두사 길이는 항상 /56이다.  


## 서브넷

서브넷은 VPC 내 논리 컨테이너로서 EC2 인스턴스를 배치하는 장소다.  
인스턴스를 서로 격리하고, 인스턴스 간 트래픽 흐름을 제어하고, 인스턴스를 기능별로 모을 수 있다.  

인스턴스는 서브넷 안에 있어야 한다.  
그리고 한 VPC에서 다른 VPC로 인스턴스를 옮길 수 없다.  


### 서브넷 CIDR 블록

서브넷의 CIDR은 VPC CIDR의 일부이면서, VPC 내에서 고유해야 한다.  
AWS는 모든 서브넷에서 처음 4개 IP 주소와 마지막 IP 주소를 예약하며, 이 주소는 인스턴스에 할당할 수 없다.  

- .0: Network address
- .1: Reserved by AWS for the VPC router
- .2: Reserved by AWS for mapping to the Amazon-provided DNS
- .3: Reserved by AWS for future use
- .255: Network broadcast address

VPC는 보조 CIDR을 가질 수 있지만, 서브넷에는 하나의 CIDR만 있다.  
VPC에 기본 CIDR과 보조 CIDR이 있는 경우, 그 중 하나에서 서브넷 CIDR을 생성할 수 있다.  


### 가용 영역

서브넷은 하나의 가용 영역(AZ, Availabiliy Zone) 내에서만 존재할 수 있다.  
AWS 리전의 가용 영역들은 서로 프라이빗으로 연결돼 있으며, 한 가용 영역에 장애가 발생하더라도 다른 영역에 장애의 영향이 미치지 않도록 설계됐다.  

서로 다른 가용 영역에 서브넷을 하나씩 만든 다음 인스턴스를 각각 서브넷에 분산해서 만들면, 애플리케이션은 복원성을 확보할 수 있다.  


## 탄력적 네트워크 인터페이스

탄력적 네트워크 인터페이스(ENI, Elastic Network Interface)를 사용하면 인스턴스가 AWS 서비스, 다른 인스턴스, 온프레미스 서버, 인터넷 등 다른 네트워크 리소스와 통신할 수 있다.  
모든 인스턴스에는 기본 ENI가 있어야 하며 이 인터페이스는 하나의 서브넷에만 연결된다.  


### 기본 프라이빗 주소와 보조 프라이빗 IP 주소

각 인스턴스는 기본 프라이빗 IP 주소를 가지고 있어야 하는데, 그 주소는 서브넷 CIDR에서 지정한 범위 내 주소여야 한다.  


### 탄력적 네트워크 인터페이스 연결

ENI는 인스턴스와 독립적으로 존재할 수 있는데, 먼저 ENI를 생성하고 나중에 인스턴스에 연결할 수 있다.  
기존 ENI를 가져와서 기존 인스턴스에 보조 ENI로 연결할 수 있으며, 장애가 있는 인스턴스에서 ENI를 분리해 작동하고 있는 다른 인스턴스에 연결하면 트래픽을 장애 인스턴스에서 정상 인스턴스로 전환할 수 있다.  


## 인터넷 게이트웨이

인터넷 게이트웨이는 퍼블릭 IP 주소를 할당받은 인스턴스가 인터넷과 연결돼서 인터넷으로부터 요청을 수신하는 기능을 제공한다.  
VPC에는 하나의 게이트웨이만 연결할 수 있다.  

인터넷 게이트웨이에는 관리형 IP 주소나 네트워크 인터페이스가 없는 대신, 식별을 위해 AWS 리소스 ID가 할당된다.  
리소스 ID는 igw-로 시작하며 그 뒤에 영숫자 문자열이 온다.  


## 라우팅 테이블

각 라우팅 테이블은 하나 이상의 라우팅과 하나 이상의 서브넷 연결로 구성되며, 기존의 라우터와 거의 같은 방식으로 여러 서브넷에 연결돼 있다.  
VPC를 생성하면 기본 라우팅 테이블을 자동으로 만들고 해당 VPC의 모든 서브넷과 연결한다.  

모든 서브넷은 라우팅 테이블에 자동으로 연결된다.  


### 라우팅

라우팅은 라우팅 테이블과 연결된 서브넷 내 인스턴스에서 트래픽을 전달하는 방법을 결정한다.  

다음과 같은 요소를 제공해야 한다.  

- 대상 주소
	- CIDR 표기법의 IP 접두사여야 한다.
- 대상
	- CIDR은 사용할 수 없으며, 인터넷 게이트웨이, ENI 등의 AWS 네트워크 리소스가 지정돼야 한다.

라우팅 테이블에는 같은 VPC에 있는 인스턴스 간에 통신할 수 있게 하는 로컬 라우팅(LOCAL)이 필수적으로 포함된다.  


### 기본 라우팅

인스턴스가 인터넷에 액세스하게 하려면 인터넷 게이트웨이를 가리키는 기본 라우팅을 생성해야 한다.  
인터넷 게이트웨이를 가리키는 기본 라우팅이 포함된 라우팅 테이블과 연결된 서브넷을 **퍼블릭 서브넷**이라고 한다.  

반면 프라이빗 서브넷은 기본 라우팅을 포함하지 않는다.  


## 보안 그룹

보안 그룹은 방화벽과 같은 기능을 제공하며, 인스턴스의 ENI에서 송수신되는 트래픽을 허가해서 인스턴스를 오가는 트래픽을 제어한다.  

모든 ENI에는 최소한 하나의 보안 그룹이 연결돼야 하고, 한 ENI에 여러 개의 보안 그룹을 연결할 수 있으며, 한 보안 그룹을 여러 개의 ENI에 연결할 수도 있다.  


### 인바운드규칙

인바운드 규칙은 연결된 ENI에 허용할 트래픽을 정의하는 것으로 다음 세 가지 필수 요소로 구성된다.  

- 원본
- 프로토콜
- 포트범위


### 아웃바운드규칙

아웃바운드 규칙은 인스턴스에 연결된 ENI를 통해 송신할 수 있는 트래픽을 정의한 것으로, 다음 세 가지 요소를 포함한다.  

- 대상 주소  
- 프로토콜  
- 포트범위  

보안 그룹을 생성할 때 AWS는 다음과 같은 아웃바운드 규칙을 자동으로 만든다.  

- 대상 주소 : 0.0.0.0/0
- 프로토콜 : 모두
- 포트범위 : 모두

이 규칙의 주목적은 인스턴스가 인터넷 및 기타 AWS 리소스에 액세스할수 있게 하는 것이다.  


### 상태저장방화벽

보안 그룹은 `상태 저장 방화벽` 역할을 한다.  
이때 상태 저장이란 보안 그룹이 트래픽을 한 방향으로 전달되도록 허용할 때 반대 방향의 응답 트래핀을 지능적으로 허용하는 것을 의미한다.  


## 네트워크 액세스 제어 목록
네트워크 액세스 제어 목록(NACL, Network Access Control List)은 원본 또는 대상 주소 CIDR, 프로토콜， 포트를 기반으로 트래픽을 허용하는 인바운드와 아웃바운드 규칙을 포함한다는 점에서 보안 그룹과 같이 방화벽 기능을 한다.  
또한 각 VPC에는 삭제할 수 없는기본 NACL이 있다는 점도 보안 그룹과 유사하다.  

하지만 NACL은 ENI가 아닌 서브넷에 연결되고, 서브넷과 연결된 NACL은 해당 서브넷과 송수신되는 트래픽을 제어한다.  
즉, 서브넷 내의 인스턴스 간 트래픽을 제어할 때는 NACL을 사용할 수 없으며, 보안 그룹을 사용해야 한다.  

서브넷에는 하나의 NACL만 연결할 수 있으며, VPC에 서브넷을 만들면 기본적으로 VPC의 기본 NACL이 서브넷에 연결된다.  

보안 그룹이 상태 저장인 것과 달리 NACL은 `상태 비저장`이다.  
NACL의 상태 비저장 특성 때문에 모든 인바운드와 아웃바운드 트래픽의 허용 규칙을 별도로 작성해야 한다.  


### 인바운드규칙

인바운드 규칙은 서브넷에 진입할 수 있는 트래픽을 정의하며, 다음 요소를 포함한다.  

- 규칙번호  
- 프로토콜  
- 포트범위  
- 원본  
- 동작( 허용/거부)

NACL 규칙은 규칙 번호의 오름차순으로 처라된다.  


### 아웃바운드규칙  

아웃바운드 NACL 규칙은 인비운드 규칙과 거의 같은 형식을 따르며, 다음 요소를 포함한다.  

- 규칙번호  
- 프로토콜  
- 포트범위  
- 대상주소  
- 동작(허용/거부)


인터넷 액세스를 차단히는 등의 서브넷에서 송신히는 트래픽을 제한해야 하는 때는 웅답 트래픽을 임시 포트를 통하도록 하는 이웃바운드 규칙을 만들 필요가 있다.  
예를 들어, 클라이언트에서 TCP 포트 80으로 인스턴스에 HTTP 요청을 보내고, TCP 포트 36034로 웅답 트래픽을 수신 대기하는 것을 예로 들 수 있다. 이 때는 NACL의 아웃바운드 규칙은 서브넷의 TCP 포트 36034에서 트래핀이 전송되도록 허용해야 한다.  


## 퍼블릭 IP 주소

퍼블릭 IP 주소는 퍼블릭 인터넷으로부터 인스턴스에 액세스하는 데 필수 요소로 인터넷이 아닌 프라이빗 네트워크 내에서만 통신할 수 있는 RFC 1918 5 의 주소와는 다르다.  


## 탄력적 IP 주소  

탄력적 IP 주소(EIP, Elastic IP Address)는 AWS에서 사용자가 요청하면 계정에 할당되는 퍼블릭 IP 주소로서, 계정에 EIP가 할당되면 사용자가 직접 해제하지 않는 한 해당 주소를 독점적으로 사용할 수 있다.  

EIP는 인스턴스와 연결되지 않은 상태로 할당된다.  
EIP는 하나의 ENI와 연결돼야 하며, 다른 ENI에 옮겨서 연결할 수 있다.  
이미 자동 할당된 퍼블릭 IP 주소가 있는 ENI에 EIP를 연결하면 AWS는 퍼블릭 IP 주소를 EIP로 바꾼다.  


## 네트워크 주소 변환  

인터넷 게이트웨이는 네트워크 주소 변환(NAT , Network Address Translation)이라는 프로세스를 사용해 퍼블릭 IP 주소와 ENI의 프라이빗 IP 주소를 연결한다.  

인스턴스에 퍼블릭 IP 주소가 있으면 인터넷 게이트웨이에서 지동으로 네트워크 주소 변환이 수행되며, 이때는 사용자가 개입할 수 없다.  
하나의 프라이빗 IP 주소가 하나의 퍼블릭 IP 주소와 연결돼 있으므로 여기서 서술한 네트워크 주소 변환을 `일대일 NAT`라고도 한다.  


## 네트워크 주소 변환 장치  

네트워크 주소 변환은 인터넷 게이트웨이에서 이뤄지지만, 다음 두 가지 서비스도 네트워크 주소 변환을 수행한다.  

* NAT 게이트웨이  
* NAT 인스턴스  

AWS는 이를 `NAT 디바이스`라고 하며, 인스턴스가 인터넷에 액세스할 수 있게 하면서 인터넷상의 호스트에서는 인스턴스에 직접 도달하지 못하게 할 때 사용한다.  
이 기능은 인스턴스가 업데이트 패치를 받거나 데이터를 업로드할 때 인터넷에 연결할 필요는 있지만, 클라이언트 요청에 응답할 필요는 없을 때 유용하다.  

### NAT 게이트웨이

NAT 게이트웨이는 AWS에서 관리하는 NAT 디바이스이며, 인터넷 게이트웨이처럼 하나의 NAT 게이트웨이로 어떠한 용량의 요청도 처리할 수 있다.  

NAT 게이트웨이를 생성할 때 EIP도 함께 할당해서 연결해야 하고, 퍼블릭 서브넷 한 곳에 배포해서 인터넷에 액세스할 수 있게 해야 한다.  


### NAT 인스턴스  

NAT 인스턴스는 사전 구성된 Linux 기반 AMI를 사용하는 일반적인 EC2 인스턴스  
이며, 여러 면에서 NAT 게이트웨이처럼 작동하지만 NAT 인스턴스는 몇 가지 중요한 다른 점이 있다.  

NAT 게이트웨이와는 달리 NAT 인스턴스는 대역폭 요구가 증가하더라도 자동으로 확장되지 않는다.  
따라서 적절한 성능을 갖춘 인스턴스 유형을 선택히는 것이 중요하다.  
대역폭 요구가 증가하면 직접 더 큰 인스턴스 유형으로 업그레이드해야 한다.  

그리고 NAT 인스턴스에는 ENI가 있으므로 보안 그룹을 적용해야 하고 퍼블릭 IP 주소를 할당해야 한다.  

NAT 인스턴스의 한 가지 이점은 배스천 호스트(Bastion Host, 또는 점프 호스트)로 사용해서 퍼블릭 IP가 없는 인스턴스에 연결할 수 있다는 것이며, NAT 게이트웨이로는 이 작업을 수행할 수 없다.  

인스턴스나 가용 영역에 장애가 발생하면 다른 NAT 인스턴스로 확장하는 정도로는 간단히 대처할 수 없는데 이는 기본 라우팅에 여러 NAT 인스턴스를 대상으로 경로를 지정할 수 없기 때문이다.  


## VPC 피어링
  
VPC 피어링을 구성하면 한 VPC의 인스턴스가 프라이빗 AWS 네트워크를 통해 다른 VPC와 통신하게 할 수 있다.  
다른 리전에 있는 인스턴스와 통신이 필요할 때에도 이 작업을 수행할 수 있으며, 한 계정의 인스턴스를 다른 계정의 인스턴스와 연결할 수도 있다.  

VPC 피어링을 활성화하려면, 두 VPC 사이에 VPC 피어링 연결을 설정해야 한다.  
VPC 피어링 연결은 두 VPC 사이의 지점 간 연결이며, 두 VPC 간에는 단 하나의 피어링만 설정할 수 있고 두 VPC의 CIDR 블록은 겹치지 않아야 한다.  

VPC 피어링 연결은 인스턴스 간 통신만 허용한다.  

피어링 연결을 사용하려면 트래픽이 양방향으로 오가도록 두 VPC에 새로운 라우팅을 만들어야 하고, 각 라우팅의 대상이 될 접두사는 대상 VPC의 범위 내에 있어야 한다.  








































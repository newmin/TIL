# 02. Amazon Elastic Compute Cloud와 Amazon Elastic Block Store
#TIL/aws/SAA

---

## EC2 인스턴스

EC2는 물리 서버의 기능을 가상화했지만 실제 서버와 유사하게 작동하며, 스토리지, 메모리, 네트워크 인터페이스, OS가 새로 설치된 기본 드라이브가 제공된다.  

### EC2 AMI

AMI(Amazon Machine Image)에는 다음과 같이 4가지 종류가 있다.  

- Amazon 빠른 시작 AMI
	- 다양한 리눅스 배포판, Windows Server OS, 딥러닝, 데이터베이스 등의 공통 작업을 위한 특수 이미지가 포함된다.
	- 가장 많이 사용하고 Amazon에서 항상 최신버전으로 공식 지원한다.
- AWS Marketplace AMI
	- 프로덕션 환경에서 사용 가능한 공식 이미지
- 커뮤니티 AMI
	- 특정한 요구에 맞도록 독립 공급업체가 제작하고 관리한다.
- 프라이빗 AMI
	- 사용자가 자체 배포한 인스턴스에서 이미지를 생성해서 저장하면 자체 프라이빗 AMI를 만들 수 있다.  

일부 AMI는 특정 리전에서 사용할 수 없으므로 배포 시에 이를 고려해야 한다.  


### 인스턴스 유형

애플리케이션에 딱 맞는 컴퓨팅 성능, 메모리, 스토리지 용량을 제공해 필요한 사양에 맞게 비용을 지출할 수 있도록 한다.  

- 범용
	- T3, T2, M5, M4
	- 컴퓨팅, 메모리, 네트워크 리소스를 균형있게 제공한다.
	- M5, M4는 주로 중소 규모 데이터 운영에 권장된다. EBS 가상 볼륨을 스토리지로 사용해야 하는 T2와는 달리 일부 M 인스턴스는 실제 호스트 서버에 물리적으로 연결된 내장 인스턴스 스토리지 드라이브와 함께 제공된다.
- 컴퓨팅 최적화
	- C5, C4
	- 대규모 요청을 받는 웹 서버와 고성능 머신 러닝 워크로드에 사용한다.
- 메모리 최적화
	- X1e, X1, R5, R4, z1d
	- 처리량이 많은 데이터베이스, 데이터 분석, 캐싱 작업에 유용하다.
- 가속화된 컴퓨팅
	- P3, P2, G3, F1
	- 고성능 범용 그래픽 처리 장치(GPGPU)가 제공된다.
	- 3D 시각화/렌더링, 재무 분석, 전산 유체 역학 등의 높은 워크로드에 사용된다.
- 스토리지 최적화
	- H1, I3, D2
	- 지연 시간이 짧은 대용량 인스턴스 스토리지 볼륨을 사용한다.
	- 분산 파일 시스템과 규모가 큰 데이터 처리 애플리케이션에 유용하다.


### 인스턴스 환경 구성

- AWS 리전
	- EC2 리소스는 사용자가 선택한 리전에서만 관리할 수 있다.
- VPC (Virtual Private Cloud)
	- VPC를 사용하면 인스턴스를 다른 인스턴스와 쉽게 분리해서 실행할 수 있고, 프로젝트 단위나 프로젝트 단계별로 VPC를 새로 만들어 사용할 수 있다.
- 테넌시
	- 기본 설정은 공유 테넌시이다. 여러 인스턴스가 한 물리 서버에서 동시에 가상 머신으로 실행된다. **(default)**
	- 특별히 격리가 필요한 규제 사항이 있는 경우, 전용 인스턴스를 선택하면 전용 서버에서 인스턴스가 실행된다.
		- 전용 인스턴스 테넌시 : 계정 내 다른 인스턴스와 같은 물리 서버에 호스팅될 수 있다. **(dedicated)** 같은 계정의 공유 테넌시 인스턴스와 호스트를 공유할 수 있음. 그러나 호스트 통제를 할 수는 없다.
		- 전용 호스트 테넌시 : 완전히 격리된 환경 **(host)**. 호스트(하드웨어)를 통제할 수 있다.


### 인스턴스 동작 구성

EC2에서는 인스턴스 구성 단계에서 사용자 데이터를 지정해 인스턴스가 부팅할 때 명령을 실행할 수 있게 하는데, 이를 `부트스트랩`이라고 한다.  
스크립트 파일을 작성해 콘솔에서 인스턴스를 시작할 때 인스턴스 세부 정보 구성에서 지정하거나 AWS CLI에서 user-data 값을 사용해 필요한 상태로 인스턴스를 구성할 수 있다.  


### 인스턴스 요금

요금 모델은 다음과 같다.  

- 온디맨드
	- 시간당 요금으로 지급한다.
	- 다만 다른 요금 모델에 비해 가장 비싸다.
- 예약
	- 인스턴스를 1년 이상, 24/7 가동할 계획이라면 1년 또는 3년 기간으로 예약 인스턴스를 구매하면 대폭 할인된 요금으로 이용할 수 있다.
- 스팟 인스턴스
	- 갑자기 중단돼도 피해가 크지 않은 워크로드 등을 가동할 때 사용하면 비용이 많이 절감된다.
	- 특정 리전에서 실행되는 인스턴스 유형에 대해 사용자가 최대 입찰 요금을 입력해서 인스턴스를 사용하는 것이다.
	- 사용자가 중지하거나 시간당 요금이 입찰가보다 높아져서 중지될 때까지 계속 실행된다.


### 인스턴스 수명 주기

인스턴스를 종료하면 사용하던 리소스는 AWS 리소스 풀로 반환된다.  

이 때 인스턴스 스토어 볼륨의 데이터는 삭제되지만, EBS 볼륨에 저장된 데이터는 삭제되지 않는다.  
또한 인스턴스에 할당된 임시 퍼블릭 IP 주소는 중지 후 재시작하면 다른 주소로 할당되며, 탄력적 IP 주소를 할당하면 고정 IP를 사용할 수 있다.  


### 리소스 태그

리소스 관리를 위해 일관된 규칙에 따라 태그를 붙여서 관리하는 것이 좋다.  
키-값의 형태로 할당할 수 있다.  


## EC2 스토리지 볼륨

스토리지 드라이브, 즉 볼륨은 물리 드라이브를 가상으로 나눈 공간이다.  
인스턴스 내의 OS에서는 모든 AWS 볼륨이 실제 물리 드라이브처럼 보인다.  


### Elastic Block Store 볼륨(EBS)

EBS는 필요한 수만큼 인스턴스에 연결할 수 있으며 물리 서버의 하드 드라이브, 플래시 드라이브, USB 드라이브와 유사하게 사용된다.  

현재 EBS 유형에는 SSD(Solid State Drive) 기술을 사용하는 두 가지 유형과 기존의 디스크 회전 구동형 HDD(Hard Disk Drive) 기술을 사용하는 두 가지 유형이 있다.  
성능은 최고 IOPS(Input/Output Operations Per Second)로 측정한다.  

- EBS 프로비저닝된 IOPS SSD (io2)
	- 고성능 I/O 작업이 필요할 때 사용한다.
	- 최대 64,000 IOPS 성능을 제공한다.
	- GB 당 주어지는 IOPS는 500:1이다.
- EBS 프로비저닝된 IOPS SSD (io1)
	- 최대 64,000 IOPS 성능을 제공한다.
	- GB 당 주어지는 IOPS는 50:1이다.
- EBS 범용 SSD
	- 일반 서버 워크로드에는 이론적으로 짧은 지연 시간 성능을 제공하는 범용 SSD가 적합하다.
	- 최대 16,000 IOPS 성능을 제공한다.
	- GB 당 주어지는 IOPS는 3:1이다.
- 처리량에 최적화된 HDD
	- 로그 처리와 빅데이터 작업 등 처리량이 많은 워크로드에 적합하다.
	- 최대 500 IOPS 성능을 제공한다.
- 콜드 HDD
	- 빈번하게 엑세스하지 않는 대용량 데이터 작업에 적합하다.
	- 250 IOPS 성능을 제공한다.

모든 EBS 볼륨은 스냅샷을 통해 복사할 수 있고, 기존 스냅샷을 다른 인스턴스에 공유해서 연결할 수 있으며, AMI에 등록할 수 있는 이미지로 변경할 수 있다.  
EBS 볼륨을 암호화해서 데이터를 보호할 수 있고, 내부에서 암호화 키를 관리하거나 AWS KMS에서 제공되는 키를 사용할 수 있다.  


### 인스턴스 스토어 볼륨

EBS 볼륨과는 다른 임시 디스크이며, 디스크가 연결된 인스턴스가 종료됐을 때 저장된 데이터는 영구히 삭제된다.  

EBS 대신 인스턴스 스토어를 사용하는 이유는 다음과 같다.  

- 인스턴스 스토어 볼륨은 인스턴스를 호스팅하고 있는 서버에 물리적 고속 NVMe 인터페이스로 연결된 SSD다.  
- 인스턴스 스토어 볼륨 요금은 인스턴스 요금에 포함돼 있다.
- 단기 역할 수행(Auto Scaling으로 잠시 생성되는 등)이나 외부에서 데이터를 가져와서 처리 후 폐기하는 모델에 적합하다.


## EC2 인스턴스 엑세스

모든 인스턴스에는 기본적으로 최소 한 개의 프라이빗 IPv4 주소가 할당된다.  
이 주소는 다음 제한된 범위에 있다.  

- 10.0.0.0 ~ 10.255.255.255
- 172.16.0.0 ~ 172.31.255.255
- 192.168..0.0 ~ 192.168.255.255


## EC2 인스턴스 보안

### 보안 그룹

EC2 보안 그룹은 방화벽 역할을 한다.  
기본 설정은 모든 트래픽을 거부하는 것이고, 보안 그룹에 지정한 트래픽 유형만을 허용하는 정책 규칙을 설정해야 한다.  

보안 그룹은 원본과 대상, 대상 네트워크 포트, 사용 프로토콜을 검사해서 트래픽을 평가한다.  


### IAM 역할

역할을 사용해서 EC2 인스턴스를 비롯한 AWS 리소스에 액세스하는 것을 제어할 수 있다.  
특정 사용자나 리소스에 역할을 할당하면, 그 사용자나 리소스는 역할 정책에 포함된 다른 리소스에 엑세스할 수 있다.  


### NAT 디바이스

때로 EC2 인스턴스에 퍼블릭 IP 주소를 연결하지 않고 네트워크 노출을 제한할 필요가 있는데, 하지만 이 때도 보안 패치와 소프트웨어 업데이트를 받으려면 제한적으로라도 인터넷에 연결돼야 하는 문제가 있다.  

AWS 는 NAT 인스턴스와 NAT 게이트웨이를 제공해서 트래픽을 라우팅하게 한다.  
NAT 게이트웨이는 관리형 서비스이므로 직접 인스턴스를 시작하고 유지 관리할 필요가 없다.  


### 키 페어

세션을 보호하기 위해서는 키 페어를 생성해서 퍼블릭 키는 EC2 인스턴스에 저장하고 다른 절반인 프라이빗 키는 사용자가 관리하게 해야 한다.  
Windows AMI에서는 프라이빗 키 파일을 이용해 인증할 비밀번호를 가져올 수 있고, Linux AMI는 프라이빗 키로 SSH 접속을 할 수 있다.  


## 기타 EC2 관련 서비스

### AWS Systems Manager

AWS 콘솔로 사용할 수 있는 Systems Manager 서비스는 AWS 클라우드와 온프레미스 인프라에서 운영하는 리소스를 모니터링하고 관리하기 위한 도구이다.  


### 배치 그룹

지연 시간이 짧은 네트워크 상호 연결이 필요한 여러 EC2 인스턴스에 유용하다.  
다음과 같은 두 가지 전략이 있다.  

- 클러스터 그룹은 단일 가용 영역 안에서 물리적으로 근접하고 서로 연결된 인스턴스를 시작한다.
- 분산형 그룹은 장애 관련 데이터나 서비스 손실 위험을 줄이기 위해 물리적으로 분리된 하드웨어에 인스턴스를 분산한다.


### AWS Elastic Beanstalk

사용자가 Beanstalk에 파라미터를 정의하고 애플리케이션 코드를 올리면, AWS는 애플리케이션 실행에 필요한 인프라를 구성, 실행, 유지한다.  
Beanstalk에는 EC2 인스턴스 로드 밸런싱, Auto Scaling, RDS 데이터베이스 인스턴스, 전체 네트워크 배치 등이 포함돼 있다.  


### AWS Elastic Container Service와 AWS Fargate

Amazon ECS를 사용하면 미리 구축된 Docker 호스트 인스턴스를 시작하고 Docker 컨테이너가 작업하는 방법을 정의할 수 있다.  
Fargate 도구는 ECS 구성 프로세스를 더욱 추상화한 도구이다.  

- AWS ECS (Elastic Container Service)
	- 도커를 추상화한 완전관리형 서비스. 도커 이미지만 ECR(Elastic Container Registry)을 통해 제공하면 해당 이미지로 EC2 인스턴스를 띄우거나 AWS Fargate에 컨테이너를 띄운다.
- AWS EKS (Elastic Kubernetes Service)
	- 쿠버네티스를 추상화한 완전관리형 서비스. 
	- 그러나 EKS로 구성한 인프라에 대한 책임은 사용자에게 있다. AWS의 책임은 쿠버네티스 자체에만 있다.
- AWS Fargate
	- 쿠버네티스가 사용할 인프라를 제공한다.
	- EKS에 수동으로 리소스(ec2 및 다른 클라우드 리소스)를 제공할 수도 있지만, Fargate를 사용하면 이 부분을 자동화할 수 있다.


### AWS Lambda

서버리스 애플리케이션은 서버에서 동작하지만 사용자가 서버를 제어하는 대신, 사전 설정된 이벤트로 AWS Lambda 서버를 트리거해서 코드를 실행하도록 구성한다.  


### VM Import/Export

온프레미스 VMware 환경과 AWS 계정 간에 S3를 거쳐 가상 머신 이미지를 쉽게 이동할 수 있다.  


### Elastic Load Balancing과 Auto Scaling

로드 밸런서는 외부 사용자 요청을 여러 EC2 인스턴스에 전송해 서버 리소스를 더욱 효율적으로 분산해서 사용할 수 있게 하고 사용자 경험을 향상시킨다.  
Auto Scaling은 사전 설정된 성능 임계값에 반응해서 수요에 따라 EC2 인스턴스 수를 자동으로 늘리거나 줄인다.  


































# 09. 안정성 핵심 요소
#TIL/aws/SAA

---

## 소개

안정성(Reliability)은 복원성(resiliency)이라고도 하며, 애플리케이션에서 장애가 일어나는 것을 예방하거나, 장애 발생 시 신속히 복구하는 능력을 뜻한다.  

애플리케이션의 안정성은 가용성(availability)으로 계량화하며, 애플리케이션이 예상대로 작동하는 시간을 백분율로 나타낸 것이다.  

애플리케이션의 가용성 수준은 네트워킹, 컴퓨팅, 스토리지 등 인프라의 일부를 구성하는 AWS 리소스의 가용성에 의존한다.  
AWS에서 제공하는 서비스도 가용성이 100%일 수는 없다.  
완벽하게 장애 발생을 막을 수는 없지만, 장애 발생 시 어떤 계획하에 어떻게 대처하느냐에 따라 애플리케이션의 가용성은 크게 달라질 수 있다.  


## 가용성 계산

가용성이랑 안정성 기준을 측정 가능하도록 계량화한 성능 지표이며, 애플리케이션이 예상한 대로 작동하는 시간을 백분율로 나타낸 것이다.  

다음은 가용성 비율을 기준으로 한 해 동안 애플리케이션이 이용이 불가능할 수 있는 기간을 보여준다.  

- 99%
	- 3일 15시간 39분
- 99.9%
	- 8시간 45분
- 99.95%
	- 4시간 22분
- 99.99%
	- 52분
- 99.999%
	- 5분

가용성은 '나인(nine)'의 개수로 표현하는 경우가 많다.  
'투 나인'은 99%, '쓰리 나인'은 99.9%, 99.95%는 '쓰리 나인 파이브'로 표현한다.  


### 기존 애플리케이션과 클라우드 네이티브 애플리케이션의 가용성 차이

AWS 아키텍트는 애플리케이션의 설계 방식에 따라 안정성이 달라질 수 있다는 점을 알고 있어야 한다.  
클라우드에서 운영하는 애플리케이션의 안정성은 기존 방식과 클라우드 네이티브 방식으로 나눠서 생각해볼 수 있다.  

- 기존 애플리케이션
	- 하나의 EC2 인스턴스와 다중 가용 영역(AZ) RDS를 배포해서 기존 애플리케이션을 실행하는 경우, 애플리케이션의 가용성은 EC2 인스턴스의 가용성과 RDS 인스턴스의 가용성에 달려있으며, 이를 `강한 의존성(hard dependencies)`이라 한다.
	- 애플리케이션의 전체 가용성을 계산하려면 강한 의존성을 지닌 리소스의 가용성을 모두 곱하면 된다.
	- 가용성을 높이고자 구성 요소를 중복해서 배치할 수 있다.
	- 각 구성 요소의 가용성은 100%에서 인스턴스 장애율을 빼서 계산한다.
		- EC2 인스턴스의 가용성이 99.99%인 경우 2개 EC2 인스턴스의 가용성은 `100% - (0.01% X 0.01%) = 99.999999%` 이다.
- 클라우드 네이티브 애플리케이션
	- 클라우드 네이티브 애플리케이션은 AWS와 같이 특정 클라우드 플랫폼의 리소스만을 사용해서 작성된다.
	- Lambda를 사용한 서버리스 애플리케이션, EC2에서 객체를 S3에 저장하는 애플리케이션, DynamoDB 등
	- 하나의 EC2 인스턴스에서 데이터베이스 스토리지로 DynamoDB를 사용하는 경우, 가용성은 `99.99% X 99.99% = 99.98%`이다.
	- 더 높은 가용성이 필요한 경우, 2개의 인스턴스를 다른 AZ에서 각각 하나씩 실행하고, ALB를 사용해서 이 두 인스턴스에 트래픽을 분배한다.
	- 2개 리전을 사용하면 가용성을 더 높일 수 있다.
		- 한 리전 내 다른 가용 영역에 각각 하나씩 인스턴스를 배포하고 ALB로 트래픽을 분산하는 구성을 만든 뒤, 이 구성을 다른 리전에 복제한 다음 Route 53 가중치 기반 라우팅 정책으로 2개 리전에 트래픽을 분산한다.
		- `100% - (0.01% X 0.01% X 0.01% X 0.01%) = 99.99999999999999%` , 식스틴 나인이다.
- Lambda로 서버리스 애플리케이션 구현
	- Lambda에서 실행되는 서버리스 애플리케이션과 EC2 인스턴스에서 실행되는 실행 파일이 어떻게 다른지 알아야 한다.
	- Lambda 함수는 일시적인 작업을 수행하는 데 유용하지만, EC2 인스턴스와 같이 지속적인 작업을 수행하는 데는 적합하지 않다.
	- Lambda는 고가용성 분산 컴퓨팅 플랫폼에서 함수를 실행하므로, 장애 발생으로 중지 또는 종료될 수 있는 EC2에 비해 가용성이 높다.


### 할당량 파악

AWS는 특정 사용자가 실수에 의해서든 혹은 의도적이든 모든 리소스를 점유해서 다른 사용자의 서비스 사용을 막는 경우가 발생하지 않도록 할당량을 두고 있다.  
네트워크 처리량, 초당 S3 PUT 요청, 리전 당 인스턴스 수, 리전 당 탄력적 IP 주소 수 등과 같이 서비스마다 할당량은 다르며 할당량 증갈글 AWS에 요청하면 용량을 높일 수 있다.  

계정에 적용된 서비스 할당량은 AWS Trusted Advisor에서 확인할 수 있다.  


### 가용성 증가

가용성을 극대화하는 가장 좋은 방법은 장애를 피하는 것이다.  
큰 인스턴스 한 개를 실행하는 대신 여러 가용 영역에 작은 인스턴스 여러 개를 분산하면, 단일 인스턴스에 장애가 발생하거나 가용 영역 전체가 중단되더라도 애플리케이션을 사용하지 못하는 상황을 피할 수 있다.  

하나의 인스턴스에 장애가 생겼다는 말은 곧 장애가 있는 인스턴스에서 감당해야 하는 부하를 다른 인스턴스가 대신 처리해야 한다는 의미이다.  
따라서 인스턴스에 장애가 발생했을 때, 동일한 인스턴스를 신속하게 생성할 수 있어야 한다.  

많은 부하가 인스턴스에 몰리면 사용이 어려울 정도로 느려지거나 아예 정지하는 문제도 생길 수 있다.  
분산 시스템으로 구성하면 인스턴스를 추가하는 수평 확장 조정으로 리소스 용량을 늘릴 수 있다.  


## EC2 Auto Scaling

EC2 Auto Scaling 서비스는 애플리케이션 장애를 방지하고, 장애가 발생했을 때 복구할 수 있는 방법을 제공한다.  
Auto Scaling은 지정한 개수의 EC2 인스턴스를 자동으로 프로비저닝해서 시작한다.  
수요가 증가하면 더 많은 인스턴스를 동적으로 추가할 수 있고, 인스턴스가 종료되거나 장애가 생기면 Auto Scaling이 자동으로 인스턴스를 교체한다.  

Auto Scaling은 시작 구성 또는 시작 템플릿에서 인스턴스의 프로비저닝 및 시작 작업을 자동으로 구성하고, 인스턴스를 구성하는 기본 파라미터와 시작할 때 실행될 스크립트를 정의한다.  


### 시작 구성

시작 구성(Launch Configuration)은 인스턴스를 수동으로 생성할 때 사용하며, AMI, 인스턴스 유형, SSH 키 페어, 보안 그룹, 인스턴스 프로필, 블록 장치 연결, EBS 최적화 여부, 배치 테넌시, 사용자 데이터 등의 구성 파라미터를 지정한다.  
시작 구성은 인스턴스를 수동으로 프로비저닝할 때 입력하는 정보와 같은 내용을 담고 있는 형식 문서이다.  

시작 구성은 기존 EC2 인스턴스에서 만들 수 있고, Auto Scaling이 인스턴스에서 설정을 복사한 뒤, 필요에 따라 그 설정을 변경해서 만들 수 있으며, 아예 백지 상태에서 처음부터 만들 수도 있다.  

시작 구성은 Auto Scaling에서만 사용되므로, 인스턴스를 직접 시작할 때 시작 구성을 활용할 수 없다.  
시작 구성을 만들고 나면 수정할 수 없으므로, 설정의 일부 내용을 수정하려면 새롭게 시작 구성을 작성해야 한다.  


### 시작 템플릿

시작 템플릿(Launch Templates)은 인스턴스를 수동으로 프로비저닝할 때 입력하는 정보를 설정 작업에 사용한다는 점에서 시작 구성과 유사하지만, 기존의 시작 구성보다 다양한 용도로 활용할 수 있다.  
Auto Scaling에서는 물론, EC2 인스턴스를 하나씩 확장할 때나 스팟 집합을 만들 때도 사용할 수 있다.  

시작 템플릿을 생성하고 난 후 수정할 수 있으며, 기존 템플릿과 수정 템플릿을 버전 별로 보관한다.  
AWS에 모든 버전을 보관하고 있다가 필요에 따라 앞 버전과 뒤 버전의 템플릿을 선택해서 사용할 수 있다.  


### Auto Scaling 그룹

Auto Scaling 그룹은 Auto Scaling이 관리하는 EC2 인스턴스의 그룹이며, Auto Scaling 그룹을 만들 때는 미리 만들어 놓은 시작 구성이나 시작 템플릿을 지정한다.  
Auto Scaling이 프로비저닝하고 유지해야 하는 가동 인스턴스의 숫자도 지정하고, Auto Scaling 그룹의 최소 및 최대 숫자도 지정하며, 유지해야 할 인스턴스의 목표 숫자도 선택적으로 설정할 수 있다.  

- 최소
	- 정상 인스턴스 수가 최솟값보다 적어지지 않도록 한다.
	- 0으로 설정하면 Auto Scaling은 인스턴스를 만들지 않고 그룹 내에서 가동 중인 모든 인스턴스를 종료한다.
- 최대
	- 정상 인스턴스 수가 최댓값을 넘지 않도록 한다.
- 목표 용량
	- 최솟값과 최댓값 사이에서 선택하며 반드시 설정해야 하는 것은 아니다.
	- 목표 용량을 지정하지 않으면 Auto Scaling은 최소 인스턴스 수로 시작하고, 목표 용량을 지정하면 Auto Scaling은 지정된 용량을 유지하기 위해 인스턴스를 추가하거나 종료한다.
	- 웹 콘솔에서는 목표 용량을 그룹 크기라고도 표시하기도 한다.


### Application Load Balancer 대상 그룹 지정

Application Load Balancer를 사용해 Auto Scaling 그룹에 있는 인스턴스로 트래픽을 분산하려면 Auto Scaling 그룹을 만들 때 ALB 대상 그룹의 이름을 넣는다.  
그러면 Auto Scaling이 새 인스턴스를 만들 때마다 자동으로 인스턴스를 ALB 대상 그룹에 추가한다.  


### 애플리케이션 인스턴스 상태 검사

기본적으로 Auto Scaling은 EC2 상태 검사를 기반으로 인스턴스의 상태를 판정한다.  

ALB를 사용해 트래픽을 인스턴스로 라우팅할 때 로드 밸런서 대상 그룹에 상태 검사를 구성할 수 있다.  
대상 그룹 상태 검사는 200에서 499 범위의 HTTP 응답 코드를 검사한다.  

ALB 상태 검사에서 인스턴스가 비정상으로 확인되면 그 인스턴스로 사용자의 트래픽이 전달되지 않도록 하고, Auto Scaling은 해당 인스턴스를 제거하고 대체 인스턴스를 만들어서 로드 밸런서의 대상 그룹에 추가해 새 인스턴스로 트래픽이 전달되도록 한다.  


## Auto Scaling 옵션

Auto Scaling에는 수요에 맞게 인스턴스의 수를 확장하는 몇 가지 다른 방법이 있다.  


### 수동 조정

그룹을 생성한 후 언제든지 Auto Scaling에서 최솟값, 목푯값, 최댓값을 변경하면 즉시 조정이 이루어진다.  


### 동적 조정 정책

AWS 관리형 리소스는 탄력성을 지니므로, 부하가 증가하면 그 부하를 처리할 수 있도록 자동으로 확장한다.  
관리형 리소스에는 S3, 로드 밸런서, 인터넷 게이트웨이, NAT 게이트웨이 등이 있다.  
반면 관리형 리소스가 아닌 EC2 인스턴스의 경우에는 사용자에게 수요에 대응할 수 있는 충분한 성능을 유지해야 하는 책임이 있다.  

인스턴스 리소스(CPU 사용률, 메모리, 디스크 공간)가 부족하면 장애로 이어질 가능성이 커지므로, 부하가 특정 지점에 이르기 직전에 동적 조정 정책으로 더 많은 인스턴스를 자동으로 프로비저닝해서 인스턴스가 과부하되지 않도록 해야 한다.  
Auto Scaling은 그룹에 있는 모든 인스턴스에 대해 다음의 집계 지표를 생성한다.  

- CPU 사용률 집계
- 대상당 평균 요청 수
- 평균 수신 네트워크 바이트
- 평균 송신 네트워크 바이트

위 지표 외에도 지표 필터를 사용해 CloudWatch Logs에서 지표를 추출해서 사용할 수도 있다.  

동적 조정 정책은 CloudWatch 경보 모니터링으로 작동하며 경보가 발생할 때 목표 용량을 늘려서 확장 조정을 수행한다.  
동적 조정 정책에는 단순 조정, 단계 조정, 대상 추적 조정의 3가지 정책이 있다.  


### 단순 조정 정책

단순 조정 정책을 사용하면 지표가 임곗값 이상으로 올라갈 때마다 Auto Scaling이 단순하게 목표 용량을 늘린다.  
그러나 목표 용량을 어느 정도까지 증가시킬 것인가는 아래의 유형 선택에 달려있다.  

- ChangeInCapacity
	- 지정한 수만큼 용량을 늘린다.
- ExactCapacity
	- 현재 값과 관계 없이 용량을 특정 값으로 설정한다.
- PercentChangeInCapacity
	- 현재 용량에서 퍼센트만큼 용량을 늘린다.

Auto Scaling이 조정을 완료한 후 경보가 계속 발생해도 지정된 휴지 기간에는 정책을 다시 실행하지 않는다.  
기본 휴지 기간은 300초이며 최소 시간 0부터 필요한 기간까지 설정할 수 있다.  


### 단계 조정 정책

단순 조정 정책으로는 애플리케이션 수요가 급격히 증가할 때 신속하면서도 충분하게 인스턴스를 추가하기 어렵다.  
이 때 단계 조정 정책을 사용해서 집계 지표가 임곗값을 초과하는 단계적 수치에 따라 인스턴스를 추가할 수 있다.  

적어도 하나의 단계 조정을 지정해야 한다.  

- 하한값
- 상한값
- 조정 유형
- 목표 용량에서 확장하는 양

단계 조정 정책에서는 워밍업 시간도 지정할 수 있다.  
워밍업 시간은 Auto Scaling이 새로 인스턴스를 추가하기 위한 판단을 내릴 때까지 소요되는 시간이다.  
기본 워밍업 시간은 300초이며, 단계 조정 정책에는 휴지 기간이 없음에 유의해야 한다.  


### 대상 추적 정책

단계 조정 정책이 너무 번거로운 경우, 지표와 대상 값만을 입력하는 대상 추적 정책을 사용할 수 있다.  
Auto Scaling은 CloudWatch 경보와 조정 정책을 생성해서 지표가 대상에 가깝게 유지하도록 인스턴스 수를 조정한다.  

인스턴스 부하에 비례해서 변동하는 지표를 정해야 하는데, Auto Scaling 그룹의 평균 사용률이나 대상별 요청 수 등을 선택한다.  

대상 추적을으로 확장 조정을 수행하는 것 외에도 인스턴스를 삭제해서 대상 지표 값을 유지할 수 있다.  
축소 조정이 필요 없다면 언제든 비활성화할 수 있으며, 아울러 단계 조정 정책처럼 워밍업 시간을 지정할 수 있다.  


### 예약된 작업

예약된 작업은 부하 패턴이 예측 가능하고, 사전에 용량을 조정하고자 할 때 유용하며, 수요가 급증하기 전에 인스턴스를 만들어 둘 수 있다는 장점이 있다.  

다음 사항을 지정해야 한다.  

- 최소, 최대, 목표 용량 값
- 시작 날짜와 시간

예약된 작업에서는 주기적으로 반복되는 정책을 설정할 수 있으므로, 반복되는 부하 패턴이 있을 때 유용하며, 예약된 정책이 삭제된 후 종료 시간을 설정할 수 있다.  


## 데이터 백업과 복구

AWS는 복원력 있게 데이터를 저장할 수 있게 하며, 데이터 손실이 발생했을 때, 데이터를 복구할 수 있도록 백업을 유지 관리할 수 있는 기능을 제공한다.  


### S3

One Zone-Infrequent Access를 제외한 모든 S3 스토리지 클래스는 여러 가용 영역에 객체를 분산해서 복제한다.  

S3 버전 관리를 활성화해 놓으면 데이터가 삭제되거나 손상되는 것을 방지할 수 있으며, 객체를 수정하면 새 버전을 만들고 필요할 때 기존 버전으로 되돌릴 수 있게 한다.  
객체를 삭제할 때에도 S3는 객체에 삭제 표시를 넣고 화면에 보이지 않게 하지만, 객체의 모든 버전은 여전히 저장돼 있다.  

다중 가용 영역 또는 리전 전체에서 장애가 있을 때를 대비해서 데이터를 보호하려면, 한 리전의 원본 버킷에서 다른 리전의 대상 버킷 간에 복제하는 리전 간 복제를 활성화해야 한다.  
리전 간 복제 시 동기식으로 복사하며, 양쪽 버킷 모두 버전 관리를 활성화해야 한다.  
원본 버킷에서 객체를 삭제해도 대상 버킷에는 삭제 작업이 복제되지 않는다.  


### Elastic File System

AWS EFS는 관리형 Network File System으로 EC2 인스턴스나 온프레미스 서버가 공유해서 사용할 수 있다.  
EFS 파일 시스템은 리전 내 여러 가용 영역에 저장돼 한 가용 영역에 장애가 일어나더라도 버텨 낼 수 있게 하지만, 버전 관리와 내장된 백업/복구 기능은 제공되지 않는다.  
따라서, 데이터 손실을 막기 위해 파일 단위로 S3 버킷이나 같은 리전에 있는 다른 EFS 파일 시스템에 백업하는 것이 좋다.  


### Elastic Block Storage

EBS는 볼륨을 같은 리전 내 여러 가용 영역에 자동으로 복제해서 한 가용 영역에 장애가 있더라도 복원할 수 있게 하지만, 데이터의 손상 가능성은 늘 존재한다.  

EBS 볼륨을 가장 손쉽게 백업할 방법은 스냅샷이며, AWS는 여러 가용 영역의 S3에 스냅샷을 지정한다.  
직접 스냅샷을 생성할 수도 있지만, Amazon Data Lifecycle Manager를 사용하면 스냅샷을 정기적으로 생성할 수 있다.  
Amazon Data Lifecycle Manager에서는 특정 시간을 지정해 스냅샷을 생성할 수 있고 수명 주기 정책을 생성하고 12시간 또는 24시간의 간격을 지정해 스냅샷을 생성할 수도 있다.  
보관할 자동 스냅샷 수량도 지정해야 하며, 최대 1000개까지 보관할 수 있다.  

EBS에 데이터를 저장할 때 간과하는 부분이 애플리케이션 로그이다.  
인스턴스가 삭제되거나 연결되지 않으면 로그가 사라지기 때문에, CloudWatch Logs를 사용해 실시간으로 로그를 수집하고 저장하도록 하는 것이 좋다.  


### 데이터베이스 복원력

관계형 데이터베이스냐 DynamoDB냐에 따라 보호 방법이 달라진다.  

- 관계형 데이터베이스
	- 데이터베이스 엔진에 내장된 기능을 사용해서 데이터베이스를 파일로 백업할 수 있다.
	- 백업 파일은 S3나 Glacier에 저장해서 보관한다.
	- 대개 백업 파일을 대상 인스턴스로 다시 복사하고 백업 파일의 콘텐츠를 데이터베이스로 가져오는 프로세스를 실행한다.
- Amazon RDS
	- 간단하게 데이터베이스 인스턴스를 스냅샷할 수 있다.
	- 스냅샷으로 몇 분만에 복구하거나 새로운 데이터베이스 인스턴스를 만들 수 있다.
- 다중 AZ RDS 배포
	- 더 높은 수준의 복원력을 확보하는 방안으로, 기본 인스턴스를 한 가용 영역에 두고 예비 인스턴스를 다른 가용 영역에 유지하는 방법이다.
	- 데이터를 기본 인스턴스에서 예비 인스턴스로 동기식으로 복제한다.
	- 장애가 발생하면 RDS는 자동으로 예비 인스턴스로 장애 조치를 수행한다.
- Amazon Aurora
	- 복원력을 최대로 확보하려면 Amazon Aurora를 사용해서 다중 Aurora 읽기 전용 복제본을 만든다.
	- Aurora는 데이터베이스를 여러 가용 영역에 저장한다.
	- Aurora는 RDS에서 유일하게 최대 15개까지 복제본을 프로비저닝할 수 있으며, 이는 각 가용 영역마다 여러 개의 복제본을 배포하기에 충분한 수이다.
- DynamoDB
	- DynamoDB는 다중 가용 영역에 테이블을 저장하므로 짧은 지연 시간 성능을 제공하는 것은 물론, 가용 영역 장애에 대처할 보호 기능도 제공한다.
	- DynamoDB 글로벌 테이블을 사용해 테이블을 다른 리전에 복제해 복원력을 더 확보할 수도 있으며, 특정 시점 복구를 구성해 DynamoDB 테이블을 자동으로 백업할 수도 있다.
	- 특정 시점 복구를 사용하면 현시점에서 5분 전부터 35일 전 사이의 특정 시점으로 복구할 수 있다.


### 복원력 있는 네트워크

모든 AWS 리소스는 네트워크에 의존하고 있으므로 네트워크 설계는 중요하다.  
두 가지 요소를 고려해야 하며, 첫 번째는 VPC를 어떻게 설계할 것인가이고, 두 번째는 외부 사용자를 VPC 내에 있는 리소스에 어떻게 연결할지이다.  


### VPC 설계 고려 사항

VPC를 만들 때 리소스에 할당할 IP 주소를 충분히 확보하려면 넉넉한 크기의 CIDR 블록을 만들어야 한다.  

VPC에 서브넷을 만들 때는 VPC CIDR 내에서 사용하지 않은 주소 공간을 충분히 확보해 나중에 서브넷을 추가할 때 여유 공간을 사용하도록 해야 한다.  
이유는 다음과 같다.  

- AWS가 리전에 가용 영역을 추가하는 일이 있기 때문이다.
- 보안상의 이유나 편리하게 관리하기 위해 리소스 분류를 위한 별도 서브넷이 필요할 수 있기 때문이다.

애플리케이션 구성 요소를 여러 서브넷으로 분리하는 것을 `멀티-티어 아키텍처(multi-tier architecture)`라고 한다.  

각 서브넷에도 공간을 충분히 남겨 둔다.  
인스턴스를 더 많이 만들면 당연히 IP 주소도 더 많이 소비하게 되므로, 수요가 증가할 때 배포할 리소스를 위해 각 서브넷에 충분한 여유 주소를 남겨 둬야 한다.  


### 외부에 연결

애플리케이션의 가용성은 사용자가 애플리케이션에 액세스할 때 사용하는 네트워크의 가용성에 따라 다르다.  
AWS에 연결할 때 인터넷을 이용하면, 어느 정도의 신뢰성과 보편성이 있어서 편리하지만, 속도와 지연 시간 수준이 다양하고 예측할 수 없다.  

AWS에 연결하기 위한 기본 수단 또는 백업 수단으로 `Direct Connect`를 선택할 수 있다.  
Direct Connect는 1Gbps나 10Gbps의 일관성 있는 전송 속도를 제공하므로 AWS에 데이터를 대량으로 전송할 때 빠르고 안정적으로 연결할 수 있다.  

Direct Connect, VPC 피어링, 외부 네트워크 VPN 연결을 사용하려면 VPC 주소가 외부 네트워크 주소와 중첩되지 않아야 하고, 가상 프라이빗 게이트웨이와 Direct Connect 가상 프라이빗 인터페이스에 IP 주소를 할당할 수 있게 충분한 공간을 확보해야 한다.  



## 가용성 설계

안정성을 구현하기 위한 아키텍처의 구성요소를 잘 이해하는 것은 중요하다.  
가용성, 복잡성, 비용 사이에는 비례 관계가 있으며, 가용성을 높이면 제공할 리소스가 많아져서 복잡성은 높아지고 비용도 늘어난다.  
AWS 아키텍트는 가용성과 비용 간의 균형을 맞춰야 한다.  
중요한 것은 조직의 요구와 우선순위다.  


### 99% 가용성 설계

가용성 목표를 99%로 한다. (3.5일/년 가동 중지)  

- 시나리오
	- 애플리케이션과 직접 설치한 SQL 데이터베이스를 단일 EC2 인스턴스에서 함께 실행
	- 스크립트로 버전 관리를 활성화한 S3 버킷에 데이터베이스 자동 백업
	- S3 수명주기 정책을 구성해서 오래된 백업을 Glacier 스토리지 클래스로 이동
	- Route 53에서 HTTP 200 OK 상태 코드를 확인하는 상태 검사로 애플리케이션 상태 모니터링
	- Route 53에서 장애 조치 레코드를 만들고 사용자의 도메인 해석 요청에 애플리케이션 주소로 반환하고, 그렇지 않으면 S3 버킷 또는 CloudFront 배포에 저장한 정적 정보 웹 페이지 위치로 반환한다.
- 복구 절차
	- 애플리케이션과 데이터베이스를 인스턴스에 구축하거나 재구축하는 많은 작업을 `CloudFormation`으로 신속하게 수행한다.
	- 새 인스턴스를 만들고, 웹과 데이터베이스 서버를 설치 및 구성하고, 스토리지에서 애플리케이션 파일을 복사하고, 보안 그룹을 설정하는 CloudFormation 템플릿을 작성한다.
- 가용성 계산
	- 복구 시간 목표 (RTO, Recovery Time Objective)
	- 복구 시점 목표 (RPO, Recovery Point Objective)는 데이터베이스를 얼마나 자주 백업하는지에 따라 예측할 수 있다는 점을 유의해야 한다.
	- 가용성 계산 시에는 내림을 해서 보수적으로 측정해야 한다.


### 99.9% 가용성 설계

- 시나리오
	- 가용성 99.9%를 이루려면 애플리케이션을 분산 설계해야 하며, 단일 리전 내 다중 가용 영역에 배포한 여러 인스턴스에서 실행되도록 한다.
	- ALB를 구성해 사용자 트래픽을 개별 인스턴스로 중개하고 상태 검사를 수행하며, 애플리케이션 웹 서버를 설치하고 중앙 저장소에서 애플리케이션 파일을 복사하도록 시작 템플릿을 작성한다.
	- Auto Scaling 그룹을 만들어 최소 인스턴스가 항상 실행되도록 한다.
- 복구 절차
	- 이 시나리오에서는 장애가 발생하면 대부분 자동으로 복구된다.
	- Auto Scaling 그룹을 구성해서 ALB 대상 상태 검사로 각 인스턴스의 상태를 판단하고, 인스턴스에 장애가 발생하면 ALB는 해당 인스턴스로 향하는 트래픽을 중단한 다음, 종료하고 새 인스턴스를 만든다.
	- 데이터베이스는 다중 AZ RDS 인스턴스를 사용하며, 한 가용 영역 전체 장애 등으로 기본 데이터베이스 인스턴스에 장애가 생기면 RDS는 다른 영역에 있는 보조 인스턴스로 장애 조치한다.
	- 데이터베이스가 손상되는 것을 방지하고자 데이터베이스 인스턴스 자동 스냅샷을 활성화하면, 특정 시점 복구가 가능해져서 RPO를 5분 이내로 줄일 수 있다.


### 99.99% 가용성 설계

높은 수익을 창출하거나 인명에 큰 영향을 주는 미션 크리티컬 애플리케이션은 여러 구성 요소가 장애를 일으켰을 때, 리소스를 더 투입하지 않고도 문제 없이 운영돼야 한다.  

- 시나리오
	- 한 리전 내 여러 가용 영역이 동시에 장애를 일으킬 가능성을 배제할 수는 없다.
	- 리전이 중단되는 피해를 막으려면 애플리케이션 인스턴스를 두 곳의 리전에서 동시에 실행해야 하며, 하나는 액티브 리전, 다른 하나는 패시브 리전으로 구성한다.
	- 한 가지 단점이 있는데, 기본 데이터베이스와 보조 데이터베이스가 모두 같은 리전에서 실행되는 것이다.
	- RDS는 한 리전에 기본 데이터베이스를, 다른 리전에 보조 데이터베이스를 둘 수 없다.
	- 대신 MySQL이나 MariaDB는 다른 리전에 다중 AZ 읽기 전용 복제본을 만들 수 있는데, 이를 사용해 다른 리전으로 비동기 복제를 진행할 수 있다.
	- 이 때 복제되는 시점 간에 지연이 있을 수 있고, 복제가 완료되기 전에 기본 데이터베이스 인스턴스에 장애가 발생하면 데이터가 손실될 수 있다.
- 복구 절차
	- 장애 조치가 결정되면 두 가지를 작업해야 한다.
	- 첫 번째로 Route 53 리소스 레코드에서 사용자를 보조 리전의 ALB로 향하게 경로를 바꿔주는 것이다.
	- 두 번째로 보조 리전의 읽기 전용 복제본을 기본 데이터베이스로 승격하는 것이다.










































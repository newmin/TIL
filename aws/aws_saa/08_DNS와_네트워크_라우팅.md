# 08. DNS와 네트워크 라우팅: Amazon Route 53과 Amazon CloudFront
#TIL/aws/SAA

---

## Domain Name System

DNS는 사람이 읽을 수 있는 도메인 이름을 기계가 읽을 수 있는 IP 주소로 연결한다.  


### 네임 스페이스

인터넷 주소 체계는 인터넷을 구성하는 수십억 개 객체를 조직화하고, 이름 변환 방식으로 관리된다.  

인터넷 이름 시스템은 도메인 이름 계층 구조의 네임 스페이스 내에서 관리되며, 사람이 읽을 수 있는 이름과 연결될 수 있도록 한다.  
이를 `계층 구조`라고 한다.  
인터넷을 여러 개 작은 네임 스페이스로 나눌 수 있다는 점, 그리고 퍼블릭 또는 프라이빗 IP 주소 블록으로 할당하거나 최상위 도메인으로 나눌 수 있기 때문이다.  


### 이름 서버

이름 서버의 역할은 `amazon.com`과 같은 도메인 이름을 실제 IP 주소와 연결하는 것이다.  
모든 컴퓨터에는 내부에 간단한 이름 서버 데이터베이스를 갖고 있다.  
이 데이터베이스에는 localhost와 같은 hostnames와 IP 주소가 연결된 항목이 포함돼 있다. (Linux - '/etc/hosts')  

로컬 이름 서버에 쿼리한 항목이 없는 경우, 컴퓨터의 네트워크 인터페이스 구성에서 지정한 외부 DNS 이름 서버 중 하나로 쿼리가 전달된다.  
이 이름 서버는 웹 브라우저 등 애플리케이션에 입력한 도메인 이름에 맞는 IP 주소를 제공해서 애플리케이션의 요청이 처리될 수 있게 한다.  


### 도메인과 도메인 이름

인터넷 주소의 관점에서 도메인은 하나 이상의 서버, 데이터 저장소나 단일 도메인 이름으로 식별되는 디지털 리소스라고 할 수 있다.  
네트워크 요청을 이 도메인 리소스로 연결하기 위해 등록한 이름을 `도메인 이름`이라고 한다.  


### 도메인 등록

최상위 이름 서버가 새 도메인 이름 쿼리에 응답하려면, 그 전에 이름 서버에 해당 도메인 이름이 등록돼 있어야 한다.  
도메인 이름 등록 대행자는 이름 서버 간에 도메인 이름 데이터를 전파한다.  

Amazon Route 53은 도메인 이름 등록 대행자의 역할을 한다.  


### 도메인 계층

도메인 이름은 여러 부분으로 구성돼 있다.  

- TLD
	- 최상위 도메인이다.  가장 오른쪽 텍스트이다.
	- `.com`, `.org`
- SLD
	- 2단계 도메인
	- `amazon.com`에서 `amazon`
	- `co.kr`의 `co`처럼 일부 국가에서 사용되는 특정 도메인일 때도 있다.
- host, 하위 도메인
	- 도메인 리소스의 하위 집합
	- `www.school.edu`, `api.school.edu`, `ftp.school.edu`의 앞부분


### FQDN

시스템의 기본 도메인 이름은 도메인의 일부 이름을 풀이할 때 DNS 설정에 따라 자동으로 추가된다.  

FQDN은 최소한의 하위 도메인과 TLD가 있는 도메인의 절대 위치가 포함돼 있다.  
TLD 뒤에 점을 붙이는 관례가 있고, 이것이 FQDN이라는 것을 알려준다.  
`administration.school.edu.`  


### 영역과 영역 파일

`영역(zone, Route 53의 호스팅 영역)`은 DNS 도메인의 하위 집합이며, `영역 파일`은 영역 내 리소스와 도메인의 DNS 주소를 연결하는 방식을 기술한 텍스트 파일이다.  

`example.com. 1h IN NS ns-750.awsdns-30.net.`  

- 이름
	- 정의된 도메인 또는 하위 도메인 이름
- TTL
	- 레코드가 만료되기 전 활성 기간
- 레코드 클래스
	- 레코드의 네임 스페이스 - 통상적으로 IN(인터넷)
- 레코드 유형
	- 레코드에 정의된 레코드 유형


### 레코드 유형

영역 파일의 리소스 레코드에 입력된 레코드 유형에 따라 레코드의 데이터 형식과 사용 방법이 결정된다.  

- A
	- 호스트 이름과 IPv4 IP 주소 연결
- CNAME
	- Canonical Name, 한 호스트 이름을 다른 호스트 이름의 대체 도메인 이름으로 지정
- MX
	- Main eXchange, 도메인을 메시지 전달 에이전트와 연결
- AAAA
	- 호스트 이름을 IPv6 IP 주소와 연결
- TXT
	- Text, 사람이나 기계가 읽을 수 있는 텍스트
- PTR
	- Pointer, 도메인 내 다른 위치를 지정 (이 유형으로 처리되지 않을 예정)
- SRV
	- 서비스 위치의 사용자 정의 레코드
- SPF
	- Sender Policy Framework, 이메일 검증 프로토콜 (RFC 7208 이후로 널리 지원되지 않음)
- NAPTR
	- Name Authority Pointer, 정규식 기반의 도메인 이름으로 대체
- CAA
	- Certification Authority Authorization, 도메인의 보안 인증서를 발급하는 인증 기관 지정
- NS
	- 영역에 사용되는 이름 서버
- SOA
	- Start Of Authority, 영역의 권한의 메타 정보 정의


### 별칭 레코드

`별칭 레코드(Alias Records)`를 사용해서 한 도메인의 트래픽을 다른 도메인으로 라우팅할 수도 있다.  
Route 53의 레코드 집합에서 사용할 수 있으며, 네트워크에서 실행되는 AWS 리소스와 직접 연결할 수 있다.  


## Amazon Route 53

Amazon Route 53은 단순한 DNS 이상의 서비스를 제공하며, 도메인 등록, DNS 관리, 가용성 모니터링(상태 검사), 라우팅 정책(트래픽 관리) 등이 주요 기능이다.  
숫자 53이 붙은 이유는 DNS 트래픽이 네트워크 포트 53번을 사용하기 때문이다.  


### 도메인 등록

Route 53을 사용해서 쉽게 도메인 등록을 할 수 있다.  
AWS 인프라와 연결할 도메인 이름 등록에 Route 53을 사용하면 운영 업무를 간소화할 수 있다.  

등록 대행자의 관리 인터페이스에서 도메인을 이전할 수 있게 한 다음, 인증 코드를 요청해서 기존 도메인을 현재 등록 대행자로부터 등록 이전할 수 있고, 이전 준비가 완료되면 Route 53에 그 코드를 제공한다.  

도메인을 현재 등록 대행자에게 그대로 두는 경우에도 Route 53으로 DNS 구성을 관리할 수 있으며, 이 때는 간단하게 Route 53 레코드 집합에 있는 이름 서버 주소를 복사해서 등록 대행자의 관리 기능에 붙여넣기만 하면 된다.  


### DNS 관리

Route 53에서는 사용자가 브라우저, 전자 메일 클라이언트, 프로그래밍 방식으로 도메인 이름을 호출할 때 전달할 것을 설정하는 호스팅 영역을 생성하고 구성할 수 있다.  

Route 53의 새 호스팅 영역 생성에서 도메인 이름을 입력하고, 퍼블릭으로 호스팅할지, 프라이빗으로 호스팅할지 선택해야 한다.  

- 프라이빗 호스팅 영역
	- 사용자가 지정한 AWS VPC 내에서만 라우팅할 수 있다.
- 퍼블릭 호스팅 영역
	- 외부 사용자가 리소스에 액세스할 수 있게 한다.

Route 53은 자동으로 SOA 레코드를 생성하고 4개의 이름 서버 주소를 제공한다.  
도메인과 생성하고자 하는 하위 도메인 사이의 관계를 정의하는 레코드 세트를 새로 생성해서 리소스가 도메인 이름에 액세스하게 한다.  


### 가용성 모니터링

Route 53은 연결된 리소스의 상태 모니터 도구와 문제가 생겼을 때 해결할 방법을 제공한다.  

레코드 세트를 생성할 때 라우팅 정책을 선택한다.  
각각 생성, 구성하고 이름을 입력한 레코드 세트에서 상태 검사를 설정하면, 상태 검사는 연결된 리소스를 정기적으로 검사한다.  

모든 것이 정상이면 Route 53은 해당 리소스로 계속해서 트래픽을 라우팅하지만, 무응답 횟수가 설정값을 넘으면 Route 53은 리소스가 오프라인인 것으로 간주하고 트래픽을 백업 리소스로 전환한다.  


### 라우팅 정책

Route 53 라우팅 정책에서는 모든 AWS 리전에서 글로벌 차원의 도메인 서비스 구현을 위해 다양한 기능이 제공된다.  

라우팅 정책 중에서 가장 단순한 것은 `단순 라우팅`이다.  
모든 요청을 지정한 IP 주소나 도메인 이름으로 라우팅한다.  
새로 레코드 세트를 만들 때 기본 정책은 `단순 라우팅`이다.  

- 가중치 기반 라우팅
	- 가중치 기반 라우팅 정책은 설정된 비율에 따라 여러 리소스로 트래픽을 라우팅한다.
	- 즉, 가중치에 따라 사용자를 할당할 수 있다.
	- Route 53에서 가중치 기반 라우팅 정책을 구성하려면, 각 서버에 별도의 레코드 세트를 생성하고, 각 레코드 세트의 세트 ID에 같은 값을 지정한 다음, 인스턴스별로 적합한 숫자 값을 입력한다. 세트 ID에 연결해서 Route 53이 그 레코드 세트에 같은 작업을 하도록 한다.
- 지연 시간 라우팅
	- 지연 시간 라우팅을 사용하면 여러 AWS 리전에서 실행되는 리소스를 활용해 인스턴스로부터 클라이언트에게 최상의 경험을 제공할 수 있다.
	- 서로 다른 두 리전에 리소스를 병렬로 배치한다는 것을 의미한다.
	- 두 레코드 세트에 같은 세트 ID의 값을 부여한 경우, 각 클라이언트에게 가장 짧은 지연 시간을 제공하는 인스턴스로 요청을 전달하도록 Route 53을 설정한다.
- 장애 조치 라우팅
	- 기본으로 지정된 리소스가 정상적으로 실행되는 동안에는 트래픽을 그쪽으로 전달하고, 기본 리소스가 오프라인이 되면 다음 트래픽은 보조 레코드 세트에서 보조로 지정된 리소스로 전송하는 방식이다.
- 지리 위치 라우팅
	- 데이터 요청에 최대한 빨리 응답하도록 트래픽을 라우팅하는 지연 시간 라우팅 정책과는 달리, 지리 위치 라우팅은 요청이 발생한 대륙, 국가, 주 등 지리적 위치를 사용해서 어떤 리소스에 전송해야 할지 결정한다.
	- 이렇게 하면 고객에게 적합한 언어로 웹 페이지를 전달하거나 법적으로 허용된 리전만으로 콘텐츠를 제한하거나 동시 마케팅 캠페인을 시작할 수 있도록 해서 콘텐츠 전달에 집중할 수 있다.
	- 단, Route 53은 요청 IP 주소가 어디에서 출발했는지 식별하지 못할 때가 있으며, 이러한 경우의 보완책으로 기본 레코드를 구성할 수 있다.
- 다중 응답 라우팅
	- 다중 응답 라우팅과 상태 검사 구성을 결합해서 리소스의 가용성을 높일 수 있다.
	- 다중 응답 기반 레코드는 단일 리소스를 가리키도록 설정하고 상태 검사와 연결할 수 있으며, 최대 8개 레코드가 병렬로 구성된 리소스를 가리키게 하고, 세트 ID 값으로 서로 연결할 수 있다.
	- Route 53은 상태 검사를 사용해 리소스 상태를 모니터링하고, 정상 리소스에 트래픽을 무작위로 라우팅한다.


### 트래픽 흐름

트래픽 흐름은 정교한 라우팅 구조를 간단하면서도 신속하게 구축할 수 있으며, 이를 위해 라우팅 템플릿을 생성하거나 변경할 수 있다.  

트래픽 흐름에서는 일반 Route 53 정책으로는 불가능한 `지리 근접 라우팅` 같은 정책을 구현할 수 있다.  
지리 근접 라우팅은 지리 위치 라우팅을 더욱 정밀한 수준으로 구현하며, 특정 위도와 경도 또는 AWS 리전과의 관계에 따라 지리적 위치를 확인할 수 있다.  


## Amazon CloudFront

Route 53은 DNS 요청 처리 방식을 최적화하는 데 사용할 수 있으며, Amazon의 글로벌 콘텐츠 전송 네트워크(CDN)인 CloudFront를 사용하면 Route 53의 핵심 과제인 '사용자에게 최대한 신속하게 콘텐츠를 전송' 업무를 도울 수 있다.  

CDN은 콘텐츠를 요청하는 최종 사용자와 지리적으로 가까운 곳에 물리적 엣지 로케이션의 네트워크를 유지 관리하며, CloudFront는 콘텐츠를 전송하는 방식을 구성할 때, 어떻게 엣지 로케이션 네트워크를 통해 콘텐츠를 배포할 것인가, 그리고 어떻게 사용자에게 전달해야 할 것인지를 정의한다.  

DNS 요청이 들어오면 Route 53은 해당 요청을 CloudFront 배포로 보내도록 도메인을 구성하며, 사용자의 요청은 자동으로 적절한 곳으로 라우팅된다.  

CloudFront는 요청이 오면, 요청을 보낸 사용자 위치를 확인하고 지연 시간이 가장 짧게 콘텐츠를 전송할 수 있는 엔드포인트가 어디인지 계산한다.  
해당 엔드포인트에 콘텐츠가 처음 요청되면, 원본 서버에서 해당 콘텐츠를 복사해 온다.  
그다음 요청부터는 엔드포인트에 캐싱된 사본을 전달해서 전송이 더욱 빨라진다.  

CloudFront 배포의 종류는 다음과 같다.  

- 웹페이지, 그래픽 콘텐츠는 웹 배포를 사용
- Adobe RTMP(Real-Time Messaging Protocol)를 사용하는 비디오 콘텐츠가 S3에 저장돼 있을 때는 CloudFront RTMP를 사용

배포 구성 시 ACM(AWS Certificate Manager) SSL/TLS 암호화 인증서를 무료로 배포에 추가할 수 있다.  
CloudFront와 사용자 장치 간에 오가는 콘텐츠에 대한 네트워크 스니퍼나 중간자 공격을 막을 수 있다.  

CloudFront가 지원하는 콘텐츠 원본은 다음과 같다.  

- Amazon S3 bucket
	- 접속 가능한 S3 bucket 전부
- AWS MediaPackage 채널 엔드포인트
	- 비디오 패키징과 제작
- AWS MediaStoreContainer 엔드포인트
	- 미디어 최적화 스토리지 서비스




































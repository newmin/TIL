# 07. CloudTrail, CloudWatch, AWS Config
#TIL/aws/SAA

---

## 소개

CloudTrail, CloudWatch, AWS Config는 AWS 리소스와 애플리케이션을 정상적으로 유지하고, 성능, 보안을 보장한다.  
다음과 같은 작업을 통해 AWS 환경에 대한 감시 업무를 지원한다.  

- 성능 추적
	- 예상되는 부하를 처리할 수 있는 충분한 성능이 있는지, 수직 확장이나 수평 확장을 수행해야 할 필요가 있는지 파악해야 한다.
	- 성능 추적을 통해 사용량의 급증을 확인하고, 이런 상황이 일시적으로 리소스를 고갈시키는지 여부를 판단할 수 있다.
- 애플리케이션 문제 탐지
	- 애플리케이션 로그의 경고 또는 오류를 통해 잠재적 문제를 미리 알 수 있게 한다.
- 보안 문제 탐지
	- 사용자가 과도한 권한을 가지고 있거나, 리소스에 의도하지 않은 엑세스를 한다는 것은 보안상 위험에 노출돼 있음을 의미한다. 
	- 사용자 활동을 추적하고 권한을 감사함으로 위험을 줄일 수 있다.
- 이벤트 로깅
	- AWS 리소스의 모든 작업을 기록해서 유지 관리하는 작업은 매우 중요한 작업이다.
	- 누가, 언제, 무슨 일을 했는지를 상세하게 기록하면 문제의 원인, 영향, 범위를 파악하는 데 도움이 된다.
- AWS 리소스 인벤토리 유지 관리
	- 리소스, 구성 방법, 리소스 간의 관계와 종속성 등을 이해하면 환경을 변경하고자 할 때 어떠한 영향이 있을지 쉽게 파악할 수 있다.
	- 리소스 인벤토리를 최신의 상태로 유지함으로써 조직이 규정을 준수하는데 도움이 된다.  

CloudTrail, CloudWatch, AWS Config의 간단한 정의는 다음과 같다.  

- CloudTrail
	- AWS 리소스의 모든 읽기, 쓰기 작업의 상세 로그를 보관해서 어떤 일이, 누구에 의해 언제 일어났는지 알 수 있고, 관련된 IP 주소도 쉽게 추적할 수 있다.
- CloudWatch
	- AWS와 (온프레미스 같은) 비AWS 리소스에서 수치 성능 지표를 수집한다.
	- 리소스의 로그 파일을 쉽게 저장 및 검색할 수 있다.
	- 지표가 임곗값을 초과할 때 알림을 전송하거나 특정 작업을 수행하기 위한 경보를 보낸다.
- AWS Config
	- AWS 리소스가 구성된 방식이 어떻게 변경됐는지를 추적해서 리소스가 서로 어떻게 관련돼 있고 과거 어느 시점에 구성됐는지 확인할 수 있다.
	- 리소스 구성과 미리 정의해 둔 기준을 비교할 수 있고, 규정을 위반하는 리소스가 있을 때는 경보를 보낸다.


## CloudTrail

`이벤트`는 AWS 리소스에서 보안 주체가 실행하는 작업의 기록이다.  
CloudTrail은 AWS 서비스의 읽기, 쓰기 작업을 기록해서 작업 내역, 관련 리소스와 리전, 작업 수행자와 작업 시기 등에 대한 상세한 기록을 제공한다.  

CloudTrail은 API 작업과 비 API 작업을 모두 기록한다.  

- API 작업
	- 인스턴스 시작, S3 버킷 생성, VPC 생성 등
- 비 API 작업
	- Management Console 로그인 등

API 이벤트로는 AWS Management 콘솔, AWS CLI, AWS SDK 등 다른 AWS 서비스에서 수행되는 작업 등이 있다.  
이벤트는 형태에 따라 관리 이벤트와 데이터 이벤트로 분류된다.  


### 관리 이벤트

관리 이벤트는 보안 주체가 AWS 리소스에서 실행하는 작업을 포함하며, 제어 플레인 작업(Control Plane Operations)으로도 부른다.  
관리 이벤트에도 아래와 같은 두 가지 유형이 있다.  

- 쓰기 전용 이벤트
	- 리소스를 변경하거나 변경할 수 있는 API 작업
- 읽기 전용 이벤트
	- 리소스를 읽되, 변경은 하지 않는 API 작업


### 데이터 이벤트

데이터 이벤트는 다음 두 가지 유형의 데이터 플레인 작업을 추적한다.  

- 대량의 작업이 수행되는 S3의 객체 수준 활동
- Lambda 함수 실행


### 이벤트 기록

CloudTrail은 기본적으로 90일간의 관리 이벤트를 기록한다.  
해당 이벤트는 이벤트 기록(Event History)이라 부르는 데이터베이스에 저장된다.  
이벤트 기록은 데이터 이벤트를 포함하지 않는다.  

CloudTrail은 각 리전별로 이벤트 기록을 별도 작성하고 해당 리전에서의 활동만 기록하지만, IAM과 Route 53 등의 글로벌 서비스 이벤트는 모든 리전의 이벤트 기록에 포함된다.  


### 추적

90일이 경과한 이벤트 기록을 저장하거나 CloudTrail이 기록하는 이벤트 유형을 사용자 정의할 때 `추적`을 만들 수 있다.  
추적은 특정 이벤트를 기록하고 지정한 S3 버킷에 CloudTrail 로그 파일을 전달하고, 로그 파일에는 JSON 형식의 로그 항목이 하나 이상 들어있다.  

- eventTime
	- 활동의 날짜와 시간을 UTC로 나타낸다.  
	- 로그 파일의 로그 항목은 타임스탬프 별로 정렬된다.
- userIdentity
	- 요청을 시작한 보안 주체의 상세 정보
	- 유형(IAM 역할, 사용자), Amazon 리소스 이름(ARN), IAM 사용자 이름이 포함된다.
- eventSource
	- 서비스의 활동이 이루어진 글로벌 엔드포인트
- eventName
	- API 작업의 이름
- awsRegion
	- 리소스가 있는 리전
	- 글로벌 서비스는 항상 `us-east-1`
- sourceIPAddress
	- 요청자의 IP 주소

단일 리전 또는 모든 리전의 이벤트를 기록하도록 설정할 수 있다.  
모든 리전에 대한 추적을 선택하면 AWS가 새 리전을 시작할 때마다 자동으로 추적 목록에 추가된다.  

한 리전에서 최대 5개의 추적을 만들 수 있다. (글로벌 추적 포함)  

추적 생성 후, CloudTrail이 이벤트를 기록하면 로그 파일은 최대 15분 이내에 S3 버킷에 기록된다.  

추적을 만들 때 관리 이벤트만 기록, 데이터 이벤트만 기록, 둘 다 기록하도록 선택할 수 있다.  
관리 이벤트를 기록할 때는 읽기 전용 이벤트 기록, 쓰기 전용 이벤트 기록, 둘 다 기록하도록 선택할 수 있다.  

웹 콘솔과 로그 관리 이벤트를 사용해서 추적을 생성하면, 글로벌 서비스 이벤트도 자동으로 기록된다.  
글로벌 서비스 이벤트는 us-east-1 리전에서 발생하는 것으로 기록된다.  

데이터 이벤트를 기록하고자 한 리전의 추적을 만들 때 해당 리전에 있는 Lambda 함수만 기록할 수 있고, 모든 리전에 적용되는 추적을 생성하면 모든 리전에서 Lambda 함수를 기록할 수 있다.  

추적 당 총 250개까지 객체를 선택할 수 있다.  
250개가 넘는 객체를 기록하려면 CloudTrail에서 모든 Lambda 함수, 모든 S3 버킷을 기록하게 한다.  


### 로그 파일 무결성 검증

CloudTrail은 로그 파일이 생성된 후에 수정 또는 삭제되지 않을 것을 보장한다.  
해커는 시스템을 공격할 때 로그 파일을 삭제하거나 수정해서 침투 기록을 덮어버리는 것이 일반적이므로, 로그 파일의 무결성 검증은 S3 버킷에서 로그 파일의 위변조 여부를 조사할 때 유용하다.  

로그 파일 무결성 검증을 활성화하면 CloudTrail이 로그 파일을 S3 버킷에 전달할 때마다 파일의 암호화 해시가 계산된다.  
로그 파일이 1 바이트라도 변경되면 전체 해시가 변경되므로, 해시를 통해 파일의 수정 여부를 쉽게 파악할 수 있다.  

CloudTrail은 매시간, 지난 한 시간 동안 전달된 모든 로그 파일의 암호화 해시를 포함하는 다이제스트 파일을 생성한다.  
CloudTrail은 이 파일을 로그 파일이 있는 버킷의 또 다른 폴더에 저장하며, 다이제스트 파일이 포함된 폴더에 별도의 권한을 추가해서 삭제가 불가능하도록 할 수 있다.  
또한 리전별로 다른 프라이빗 키를 사용해서 다이제스트 파일을 암호화 서명하고 파일의 S3 객체 메타 데이터에 서명을 저장한다.  

각 다이제스트 파일은 이전 다이제스트 파일이 있을 때, 해당 내용도 해시에 포함하고, 한 시간 동안 기록할 이벤트가 없어도 다이제스트 파일은 계속 생성되므로, 해시를 확인하면 전달된 로그 파일이 없음을 확신할 수 있다.  

AWS CLI를 사용해서 무결성을 검증하려 할 때는 추적의 ARN과 시작 시간을 지정한다.  
AWS CLI는 시작 시간부터 현재까지의 모든 로그 파일의 유효성을 검사한다.  


## CloudWatch

CloudWatch는 AWS 내부 및 외부 리소스의 수처 성능 지표를 수집하고, 검색하고, 그래프로 만들 수 있는 지표 저장소 역할을 한다.  

- EC2 인스턴스 CPU 사용률
- EBS 볼륨 읽기/쓰기 IOPS
- S3 버킷 크기
- DynamoDB 읽기/쓰기 용량 단위 사용량
- 자체 애플리케이션과 온프레미스 환경의 서버의 사용자 정의 지표

CloudWatch 경보를 사용하면 지표 값을 기반으로 알림을 보내거나 작업을 수행할 수 있다.  

CloudWatch Logs를 통해 AWS 및 비 AWS 원본에서 로그를 수집, 저장, 확인, 검색할 수 있고, 사용자 지정 지표도 추출할 수 있다.  


### CloudWatch 지표

CloudWatch는 지표를 네임 스페이스로 구성하며, AWS 서비스에서 나온 지표는 AWS 네임 스페이스에 저장되고, `AWS/서비스` 형식으로 지표를 분류할 수 있다.  
네임 스페이스는 지표의 컨테이너라고 할 수 있으며, 유사한 이름의 다른 지표와 혼동하지 않게 해준다.  

지표는 변수로 작동하며 시간 순서별로 모아놓은 데이터 포인트를 포함한다.  
각 데이터 포인트에는 타임스탬프, 값, 선택적 측정 단위가 포함된다.  

`차원`은 같은 이름과 네임 스페이스를 가진 지표를 각각 구분하는 이름-값 형태의 페어로 구성된다.  

AWS 서비스가 CloudWatch에 지표를 전송하는 빈도는 서비스의 모니터링 유형에 따라 달라진다.  

- 기본 모니터링
	- 5분마다 CloudWatch에 지표를 보낸다.
	- EC2는 기본 모니터링을 사용하고, EBS는 gp2 볼륨을 대상으로 기본 모니터링을 지원한다.
		- EC2는 1분마다 통계를 수집하지만, 5분 동안의 평균 데이터만을 CloudWatch에 보낸다.
			- Xen 하이퍼바이저의 경우 EC2는 5분 간격으로 지표를 게시한다.
			- Nitro 하이퍼바이저의 경우 EC2는 1분 간격으로 5분 안의 누적 평균을 데이터 포인트로 전송한다.
- 세부 모니터링
	- 매분 CloudWatch에 지표를 게시한다.
	- EBS는 기본적으로 io1 볼륨의 세부 모니터링을 지원한다.

AWS 서비스에서 생성된 지표는 1분 이상의 타임스탬프 정밀도를 지닌다.  
예를 들어 14:00:28에 수행된 CPUUtilization의 측정에는 14:00로 타임스탬프가 찍히는데, 이를 `일반 정밀도 지표`라 부른다.  
EBS와 같은 일부 AWS 서비스는 5분 단위로 지표를 저장한다.  

CloudWatch는 최대 1초 단위로 사용자 정의 지표를 저장할 수 있는데, 이와 같이 1분 미만의 정밀도지표를 `고정밀도 지표`라 부른다.  

CloudWatch에서는 지표가 삭제되지 않고, 자동으로 만료된다.  
만료 시점은 정밀도 수준에 따라 달라지고, 시간이 경과할수록 CloudWatch는 고정밀도 지표를 저정밀도 지표로 통합한다.  

고정밀도 지표는 처음 3시간 동안 저장되고, 이후 모든 데이터 포인트는 1분 단위로 통합돼 1분 데이터 포인트 한 개가 남는다.  
고정밀도 데이터 포인트는 만료와 삭제가 동시에 이뤄지는데, **15일이 지나면** 1분 단위 5개 데이터 포인트가 5분 단위 데이터 포인트 1개로 통합되고 이 지표는 **63일 동안** 유지된다.  
보존 기간 이후에는 **각 지표의 12개 데이터 포인트가 1시간 단위로 통합돼 15개월 동안** 유지된 뒤 삭제된다.  


### 지표 그래프 작성

CloudWatch를 사용하면 시간 경과에 따라 데이터 포인트를 그래프로 표시해 지표를 시각화할 수 있다.  

CloudWatch는 일정 기간 데이터 포인트의 통계 분석을 수행하고 결과를 시계열 그래프로 나타내며, 다음 통계 표기 방식 중 선택할 수 있다.  

- 합계
	- 해당 기간 모든 데이터 포인트 합계  
- 최소
	- 해당 기간 가장 낮은 데이터 포인트  
- 최대
	- 해당 기간 가장 높은 데이터 포인트  
- 평균
	- 해당 기간 모든 데이터 포인트 평균  
- 샘플수
	- 해당 기간 데이터 포인트 수  
- 백분율
	- 지정된 백분율 데이터 포인트로 표시(소수점 이하 두 자리까지)
	- 99.44는 해당 기간 중 99.44%보다 높은 데이터 포인트 중에서 가장 낮은 데이터 포인트를 산출한다.  (p99.44)

지표를 그래프로 표시하려면 지표, 통계, 기간을 지정해야 하며, 기간은 1초에서 30일까지이고 기본값은 60초이다.  
CloudWatch에서 지표를 그대로 그래프로 나타내려면, **Sum 통계**를 사용하고 기간을 지표 단위와 같게 설정한다.  

어떤 데이터에서, 어떤 지표를 통해, 어떤 내용을 파악하려는지 에 따라 통계값이 달라질 수 있다.  
CPU 사용 패턴을 파악하려면 합계 통계는 의미가 없을 것이고, 평균 통계를 사용해야 한다.  


### 지표수식  

CloudWatch를 사용하면 지표를 이용해서 다양한 수학 함수를 실행하고 새로운 시계열 그래프를 그릴 수 있다.  
그리고 지표 데이터에 대한 더하기, 빼기, 곱하기, 나누기, 지수를 포함한 산술 함수를 사용해 여러 지표를 하나의 시계열로 결합할 때 특히 유용하다.  

CloudWatch는 산술 함수 외에도 다음과 같은 통계 함수를 제공해서 지표 수식에서 사용할 수 있게 한다.  

* AVG
	* 평균  
* MAX
	* 최대  
* MIN
	* 최소  
* STDDEV
	* 표준 편차  
* SUM
	* 합계

통계 함수는 시계열이 아닌 스칼라 값을 반환하므로 그래프로 표시할 수 없으며, 시각화를 위해서는 선택한 모든 지표의 시계열 배열을 반환히는 `METRICS` 함수를 함께 사용한다.  


## CloudWatch Logs

CloudWatch Logs는 AWS와 비 AWS 원본에서 로그를 수집해서 저장하고 Cloud scape에서 사용자 정의 지표를 검색하고 추출까지 할 수 있으며, CloudTrail 로그 수신, 인스턴스에서 애플리케이션 로그 수집, Route 53 DNS 쿼리 기록 등의 기능을 제공한다.  


### 로그 스트림과 로그 그룹  

CloudWatch Logs는 로그 이벤트, 즉 애플리케이션이나 AWS 리소스에서의 활동 기록을 저장한다.  
CloudWatch Logs가 로그 이벤트를 이해하려면 이벤트에 타임스탬프와 UTF-8으로 인코딩된 이벤트 메시지가 있어야 한다.  

CloudWatch Logs는 같은 원본에서 나온 로그 이벤트를 로그 스트림에 저장하는데, 이 때 원본은 애플리케이션이나 AWS 리소스가 될 수 있다.  
예를 들어 웹 서버를 실행하는 인스턴스가 여러 개에서 액세스 로그가 생성되고 있을 때, 각 인스턴스는 CloudTrail에 별도 스트림으로 해당 로그를 보낸다.  
로그 스트림은 삭제할 수 있지만, 개별 로그 이벤트는 삭제할 수 없다.  

CloudWatch는 로그 스트림을 로그 그룹에 포함시킬 수 있는데, 하나의 스트림은 한 로그 그룹에만 속한다.  
로그 스트림을 효율적으로 관리하려면, 유사한 로그 스트림을 같은 로그 그룹에 배치하면 되며, 그룹에 포함되는 스트림의 수에는 제한이 없다.  

로그 그룹의 보존 설정을 정의하고 로그 이벤트를 1일에서 10년까지 유지하도록 선택할 수 있다.  
보존 설정 기본값은 로그 이벤트를 무기한으로 유지하는 것이다.  
보존 설정은 로그 그룹 내 모든 로그 스트림에 적용되고, 로그 그룹을 S3 버킷으로 직접 내보내서 보관할 수 있다.  


### 지표 필터

지표 필터로 로그 그룹의 로그로부터 데이터를 추출해서 CloudWatch 지표를 만들 수 있으며, 이를 통해 로그 파일의 특정 위치에서 문자열의 발생을 추적할 수 있다.  

CloudWatch Logs는 필터와 일치하는 로그 이벤트를 수신할 때마다 사용자 정의 지표를 증가시킨다.  

지표 값은 숫자여야 한다.  
지표 필터로 요청 당 전송 바이트 수와 같은 숫자 값을 추출하고 지표에 저장할 수 있지만, IP 주소와 같은 숫자가 아닌 문자열을 로그에서 추출하거나 지표로 저장할 수 없다.  
단, 지표 필터가 특정 문자열과 일치할 때는 지표에 추가할 수 있다.  

지표 필터는 로그 그룹에 적용하며 그룹을 만든 후에 지표 필터를 만들 수 있지만, 소급 적용은 불가하다.  
즉 지표 필터를 만들기 전에 기록된 CloudWatch 로그 이벤트로는 지표를 생성할 수 없다.  


### CloudWatch 에이전트  

CloudWatch 에이전트는 Linux나 Windows 운영 체제를 실행하는 EC2 인스턴스와 온프레미스 서버에서 로그를 수집한다.  
EC2에서 생성히는 지표와 메모리 사용률 같이 기본으로 지원하지 않는 지표를 포함해서 성능 지표를 수집할 수 있다.  


### CloudTrail Logs를 CloudWatch Logs로 전송  

CloudTrail을 구성해서 추적 로그를 CloudWatch Logs의 로그 스트림에 보내고, 이를 통해 추적 로그에서 지표를 추출하고 검색할 수 있다.  
CloudTrail은 JSON 형식의 추적 로그를 생성해서 지정한 S3 버킷에 저장할 수 있지만, 로그의 검색 기능은 제공하지 않는다.  
반면 CloudWatch는 JSON 형식으로 특정 이벤트를 쉽게 검색할 수 있다.  

사용자가 검색하려는 로그 그룹과 IAM 역할을 지정하면, CloudTrail은 자동으로 역할을 생성하고 로그 그룹에 그 역할을 부여한다.  
디음 CloudTrail은 CloudWatch Logs 에 자동으로 새로운 추적 로그를 전달하기 시작한다.  

CloudTrail은 256KB보다 큰 로그 이벤트를 CloudWatch Logs 에 보내지 못한다.  


## CloudWatch 경보

CloudWatch 경보는 단일 지표를 감시하고 일정 기간 동안 해당 지표를 모니터 링하다가 경보를 생성할 수 있으며, 이를 받은 CloudWatch는  전자 메일 알림 보내기, 인스턴스 재부팅, Auto Scaling 등의 작업을 실행한다.  

경보를 생성하려면 먼저 CloudWatch가 모니터할 지표를 정의해야 한다.  

CloudWatch 경보는 지표를 바로 모니터링하지 않으며, 시간 경과에 따른 지표의 통계 분석을 수행하고 결과를 모니터링한다.  
이를 `모니터링할 데이터 포인트`라 한다.  


### 모니터링할 데이터 포인트  

예를 들어, 15분 동안 AWS/EBS VolumeReadOps 지표의 평균을 모니터링할 때, 지표의 정밀도는 5분이다.  
시용자가 통계값으로 평균을 선택하고 기간은 15분을 선택하면, CloudWatch는 15분마다 3개(5분당 1개씩)의 지표 데이터 포인트를 가져오고 평균을 구해서 모니터할 단일 데이터 포인트를 생성한다.  

> 기간은 지표의 정밀도보다 크거나 같게 설정해야 한다.  
> 더 낮은 기간을 선택하면(예를 들어 1분), 5분 마다 한 번만 지표를 업데이트하기 때문에 5개 지표 중 4개가 빠진 것으로 계산되고, 경보가 오작동하게 된다.  

통계값으로 백분위를 사용할 때는 통계적으로 유의미한 데이터 포인트 수가 누적될 때까지 경보가 전송된 데이터 포인트를 무시할지를 선택한다.   
통계적으로 유의미하기 위해서는 백분위를 설정해야 한다.  

- 백분위 수를 0.5(p50) 이상으로 설정
	- 통계적으로 유의미한 샘플을 얻으려면 `10/(1-백분위 수)` 개 데이터 포인트가 있어야 한다.
	- 통계를 p80으로 하변 통계적으로 유의미하기 위해 10/(1 - 0.8), 즉 50개 데이터 포인트가 있어야 한다.
- 백분위 수를 0.5 미만으로 설정
	- 통계적으로 유의미한 샘플을 얻으려면 `10/(백분위 수)` 개 데이터 포인트가 필요하다.
	- p25 통계를 사용했다면 10/(0.25), 즉 40개 데이터 포인트가 필요하다.
 
통계적으로 중요한 생플이 모이기 전에 전송된 데이터 포인트를 무시하도록 하면 CloudWatch는 데이터 포인트를 전혀 평가하지 않게 되고, 경보를 효과적으로 비활성화시킬 수 있다.  


### 임곗값  

임곗값(Threshold)은 모니터링할 데이터 포인트가 특정 기준을 충족하거나 무슨 문제가 발생했다는 것을 알려주는 값이며, 값과 조건으로 정의한다. (CPUUtilization >= 50)


### 경보상태  

경보에는 다음 3가지 상태가 있다.  

* ALARM
	* 경보에 대한 데이터 포인트가 일정 시간 동안 지정된 임곗값을 초과한 경우
* OK
	* 경보에 대한 데이터 포인트가 일정 시간 동안 지정된 임곗값 범위에 있는 경우
* INSUFFICIENT_DATA
	* 경보에 대한 데이터 포인트가 지정된 임곗값을 넘었는지 아닌지를 결정하기에 충분한 데이터를 확보하지 못한 경우

새로운 경보는 항상 INSUFFICIENT_DATA 상태에서 시작되는데, ALARM 상태가 항상 문제가 있음을 나타내는 것은 아니며, OK 상태가 문제가 전혀 없음을 나타내는 것도 아니다.  
경보 상태는 일정 시간 동안 경보에 대한 데이터 포인트가 임곗값을 초과하고 그 상태로 있는지만 추적한다.  


### 경보에 대한 데이터 포인트와 평가 기간  

경보에 대한 데이터 포인트에 따라 경보 상태를 변경하는 경우, 데이터 포인트가 임곗값을 초과한 뒤 유지되는 기간에 따라 달라진다.  

모니터링할 데이터 포인트가 주기적으로 임곗값을 넘지만, 계속 유지되는 것은 아닐 때 트리거해야할 때가 있으며, 이를 위해 경보에 대한 데이터 포인트와 같거나 큰 평가 기간을 설정할 수 있다.  
이때, 연속적으로 초과하는 값이 니올 필요는 없다.  
이를 n개 중 m개가 임곗값을 초과할 때 경보( m out of n alarm) 라고 부른다.  
이때 m은 경보의 데이터 포인트, n은 평가 기간을 의미하고, 평가 기간은 24시간을 초과할 수 없다.  


### 누락데이터  

평가 기간 중에 EBS 볼륨을 인스턴스에서 분리하거나 인스턴스를 중지하면 로그 데이터가 누락될 수 있으며 CloudWatch에서 누락 데이터를 평가하는 방법은 다음과 같다.   

- As Missing
	- 누락 데이터를 마치 발생한 적이 없는 것처럼 취급한다.
	- 평가 기간에 누락 데이터를 고려하지 않는 것이 As missing의 기본설정이다.
- Not Breaching
	- 누락 데이터 포인트가 임곗값을 위반하지 않는 것으로 간주한다.
- Breaching
	- 누락 데이터 발생시 임곗값을 위반하는 것으로 간주한다.
- Ignore
	- 경보에 대한 데이터 포인트 설정에서 지정된 연속적인 데이터 포인트 개수를 수신할 때까지 상태를 변경하지 않는다.


### 작업  

상태 전환 시 작업을 수행하도록 경보를 구성할 수 있으며, 경보가 ALARM 상태로 전환될 때는 물론, OK 상태로 전환될 때에도 CloudWatch가 작업을 수행하게 할 수 있다.  

- Simple Notification Service(SNS)를 이용한 알림
	- SNS는 주제라고 하는 통신 채널을 사용하며, 발신자나 게시자가 구독자라고 하는 한 명 이상의 수신자들에게 알림을 보낼 수 있다.
	- 구독자는 프로토콜과 엔드포인트로 구성되고, 프로토콜은 HTTP,  HTTPS, SQS,  Lambda, 모바일 푸시 알림, 전자 메일, 전자 메일 -JSON, SMS(Short Message Service)를 사용할 수 있다.
	- 엔드포인트는 프로토콜에 따라 다르며， 전자 메일이나 전자 메일 ]SON의 엔드포인트는 전자 메일 주소이다. SQS는 대기열이 되며, HTTP나 HTTPS의 엔드포인트는 URL이다.
	- 경보 작업을 생성할 때 SNS 주제를 지정하면, 경보가 트리거될 때 해당 주제의 알림이 구독자에게 전달된다.
- Auto Scaling 작업
	- Auto Scaling 시용시, 간단한 Auto Scaling 정책을 만들어 인스턴스를 추가하거나 제거할 수 있다.
- EC2 작업
	- 경보 상태 변경에 대한 응답으로 인스턴스를 중지, 종료, 재부팅, 복구할 수 있다.
	- AWS/EC2 StatusCheckFailed_Instance 지표를 모니터링하도록 선택해서 메모리 고갈, 파일 시스템 손상, 네트워크 이상, 시작 구성과 같은 인스턴스의 문제를 확인할 수 있으며, 이러한 문제는 인스턴스를 재부팅해서 해결한다.
	- StatusCheckFailed Instance 지표를 모니터링해서 네트워크 연결이나 전원의 손실, 하이퍼바이저 문제, 하드웨어 오류와 같이 AWS 간섭이 필요한 문제가 있을 때 1을 반환하게 할 수 있다.
	- EC2 작업은 지정한 작업을 특정 인스턴스에 수행하므로 모니터링할 지표가 Instanceld 차원을 포함할 때만 사용할 수 있다.
	- 단일 경보로 여러 개 작업을 수행할 수 있지만, 작업 수행 조건으로는 한가지의 상태 전환만 지정할 수 있다.


## AWS Config

AWS Config는 특정 시점에 AWS 리소스가 어떻게 구성됐는가를 추적한다.  
`리소스`는 Management Console, AWS CLI, AWS SDK를 시용해서 만들고 관리하는 항목이다.  
AWS Config는 타임머신으로 생각하면 되며, 과거 특정 시점에 리소스가 어떻게 구성돼 있었는지 알 수 있다.  

또한 리소스가 서로 어떻게 관련됐는지 보여줄 수 있으므로 한 리소스의 변경이 다른 리소스에 어떤 영향을 줄 수 있는지 확인할 수 있다.  

CloudTrail은 이벤트를 기록하고 CloudWatch는 이벤트를 경보할 수 있지만, AWS Config는 리소스를 전체적으로 보여주고, 과거 특정 시점에 어떻게 구성됐는지 알려준다.  

AWS Config의 주요 기능은 다음과 같다.  

- 보안
	- AWS Config는 리소스 구성이 변경될 때마다 사용자에게 잠재적인 침해 위험을 경보하도록 알릴 수 있고, 특정 시점에 사용자에게 어떤 권한이 있었는지 확인할 수 있다.
- 쉬운 감사보고서
	- 어떤 시점의 구성 스냅삿 보고서를 제공할 수 있다.
- 문제 해결
	- 문제가 시작된 시점의 구성을 분석할 수 있다.
- 변경 관리
	- AWS Config를 사용하면 한 리소스에서 변경이 이뤄질 때 다른 리소스에 어떻게 영향을 줄 수 있는지 확인할 수 있다.


### 구성레코더  

구성 레코더는 AWS Config의 핵심 기능으로, 리소스를 탐색하고 구성 방법을 기록하며 변경 사항을 모니터링하고 시간 경과에 따라 변경 내용을 추적한다.  


### 구성항목  

구성 레코더는 모니터링하는 각 리소스의 구성 항목을 생성한다.  
구성 항목에는 특정 시점의 리소스 설정, 리소스 유형, 해당 ARN, 작성 시기 등의 정보와 다른 리소스와의 관계가 포함된다.  

AWS Config는 리소스가 삭제된 후에도 모든 리소스의 구성 항목을 확인할 수 있고, 이들 정보는 AWS Config에 내부적으로 저장되고 수동으로 삭제할 수 없다.  


### 구성기록  

AWS Config는 구성 항목을 이용해서 지정된 리소스의 구성 항목 모음인 구성 기록을 작성한다.  
구성 기록에는 작성 시점, 다른 시점의 구성 방법, 삭제된 시점 등 리소스의 세부 정보가 포함되며, CloudTrail이 기록한 관련 API도 포함된다.  

6시간마다 리소스를 점검해서 변경이 있으면, AWS Config는 지정된 S3 버킷에 구성 기록 파일을 전달한다.  
파일은 리소스 유형별로 나뉜다.  

파일은 타임스탬프 처리되고 날짜별로 별도의 폴더에 보관된다.  
또한, AWS Config Console 에서 구성 기록을 직접 볼  수도 있으며, 필요에 따라 SNS 주제를 전송 채널에 추가해서 리소스가 변경될 때마다 AWS Config에서 즉시 알림을 보내게 할 수 있다.  


### 구성 스냅삿  

구성 스냅삿은 특정 시점의 모든 구성 항목 모음이며, 계정 내에서 모니터링되는 리소스 전체의 구성 백업으로 간주한다.  
AWS Config는 AWS CLI를 사용해서 전송 채널로 지정된 버킷에 구성 스냅삿을 전송할 수 있다.  
기본 전송 채널의 이름은 default이다.  

AWS Config는 일정한 간격으로 구성 스냅삿을 전송 채널에 자동으로 전송할 수 있지만, 콘솔에서는 자동 전송을 설정할 수 없고 CLI를 사용해서 구성한다.  
이때, 다음 항목이 반드시 포함된 JSON 파일도 함께 지정한다.  

* 전송 채널 이름
* S3 버킷 이름
* 구성 스냅삿의 전송 빈도


### 변경모니터링  

구성 레코더는 리소스가 생성, 변경, 삭제될 때마다 하나 이상의 새 구성 항목을 생성하며, 새 항목은 해당 리소스의 구성 기록과 해당 계정의 구성기록에 추가된다.  
하나의 리소스를 변경하면 변경된 리소스의 새 구성 항목뿐 아니라 관련 리소스의 새 구성 항목도 트리거된다.  
예를 들어 보안 그룹에서 규칙을 제거하면 구성 레코더가 보안 그룹에서도 새 구성 항목을 만들지만, 해당 보안 그룹을 사용하는 모든 인스턴스에서도 새 항목을 만든다.  

구성 항목을 수동으로 삭제할 수는 없지만, AWS Config에서 구성 항목을 30일에서 7년 사이를 유지 할 수 있도록 설정할 수 있으며, 기본값은 7년이다.  
AWS Config가 S3에 제공하는 구성 기록과 구성 스냅삿 파일에는 보존 기간이 적용되지 않는다.  

웹 콘솔이나 CLI를 사용해서 언제든지 구성 레코더를 시작하고 중지할 수 있으며, 구성 레코더가 중지된 동안에는 변경 사항을 모니터링하거나 기록하지 않지만, 기존 구성 항목은그대로 유지된다.  

AWS Config는 EC2 인스턴스나 온프레미스 서버의 소프트웨어 인벤토리 변경 사항을 기록할 수 있다.  
소프트웨어 인벤토리는 다음과 같다.  

* 애플리케이션
* CLI, SDK와 같은 AWS 구성 요소
* 운영 체제의 이름 및 버전
* IP 주소, 게이트웨이, 서브넷 마스크
* 방화벽 구성
* Windows 업데이트

AWS Config가 이들의 변경 사항을 추적하도록 하려면 EC2 Systems Manager를 사용해 서버의 인벤토리 수집을 활성화해야 하고, AWS Config가 SSM:ManagedInstanceInventory 리소스 유형을 모니터링하도록 해야 한다.  

AWS Config를 사용하면 리소스 변경을 모니터링하는 것 외에도 리소스의 최적 기본 구성을 정의하는 규칙을 지정할 수 있고, 이를 위해 다양한 사용자 시나리오가 반영된 사전 정의 규칙을 제공한다.  
특정 리소스가 규칙을 벗어난 경우, AWS Config가 해당 리소스에 플래그를 지정하고 SNS 알림을 발생한다.  

규칙을 활성화하면 AWS Config는 규칙에 따라 모니터링된 리소스를 즉시 검사해 정책 준수 여부를 확인한 뒤, 규칙 구성에서 리소스를 재평가하는 주기를 정할 수 있다.  
재평가는 구성이 변경될 때나 주기적으로 트리거 될 수 있고, 주기적 검사는 1, 3, 6, 12, 24시간 단위로 수행되며, 구성 레코더를 중지해도 주기적 규칙은 계속 실행된다.  






























































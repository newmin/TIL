# 8. 모니터링 시스템 구축 및 활용

## 서버 모니터링
- 인프라에 대한 모니터링 : 인프라 장애 혹은 징후 탐색
- 클라이언트의 요청에 대한 모니터링 : 의도된 요청인지, 공격 시도가 들어오고 있지는 않은지, 요청량 파악
- 애플리케이션에 대한 모니터링 : 배포된 코드가 예상대로 동작하고 있는지, 어떤 부분이 병목으로 성능 저하를 일으키는지
- 데이터에 대한 모니터링 : 데이터가 의도한 형태로 잘 쌓이고 있는지, 어떤 속도로 쌓이고 있는지  


## AWS CloudWatch
AWS 내 자원과 애플리케이션에 대한 모니터링 및 관리 서비스.

### CloudWatch 지표

- 네임스페이스 : 비슷한 지표들을 모아두기 위해 사용하는 네임스페이스. Auto Scaling 그룹이나 로드 밸런서 같은 항복들이 될 수 있다.
- 이름 : 지표의 이름. 인스턴스 수, CPU 사용률 등
- 차원 : 지표를 쉽게 분류하기 위한 값. 키/값 쌍으로 최대 10개 등록 가능. 같은 차원으로 표시된 지표만 따로 모아서 볼 수 있다.
- 그 외 시간, 값, 단위

#### [실습] CloudWatch에 사용자 지정 지표 기록

- aws cli를 사용한다. 해당 사용자 계정에 [cloudwatch:PutMetricData] 권한이 부여돼 있어야 한다.
	- 사용하는 인스턴스에도 aws configure를 통해 사용자 등록이 되어 있어야 한다.

#### [실습] CloudWatch Agent로 메모리, 디스크 사용량 지표, 로그 기록

AWS에서는 CPU 사용량, 네트워크 트래픽, 디스크 읽기/쓰기 등의 지표들은 기본적으로 기록해주지만, OS에 접근해야 하는 매모리, 디스크 사용량은 기본적으로 제공하지 않는다.   

에전에는 시스템 지표를 읽어와 CloudWatch 지표로 등록하는 스크립트를 배포했지만, 최근에는 시스템 지표 기록과 더불어 CloudWatch 로그 모니터링까지 함께 관리할 수 있는 CloudWatch 에이전트를 만들어서 제공한다.  

- 에이전트가 실행되는 인스턴스에 [CloudWatchAgentServerPolicy] 정책이 허용돼 있어야 한다.


### CloudWatch 대시보드

지표의 수가 많아지면 한 눈에 파악하기가 어렵기 때문에 AWS에서는 대시보드 기능을 제공한다.  

여러 지표를 종합해서 보여주기 때문에 각 서비스 간의 상관관계를 따져 장애의 원인을 파악하기가 매우 쉬워진다.  

### CloudWatch 경보

경보는 `기간`과 `값`을 이용해 조건을 걸어두어 생성할 수 있다. 이 조건을 기준으로 [정상]과 [경보] "상태"를 왔다 갔다 하게 된다.  

단순히 상태만 변경되는 것이 아니라 상태 변경에 따른 작업들을 자동으로 진행할 수 있다.  

관리자들에게 알림을 보낼 수도 있고, AWS 내 리소스들을 알아서 조작할 수도 있다.  

- 예를 들어 Auto Scaling 그룹 생성 시 [조정 정책]을 설정해 CPU 사용률이 80%가 넘어가는 경우 인스턴스의 수를 최소 1개에서 최대 2개로 늘리도록 설정해 놨다면, 자동으로 CloudWatch 경보 2개가 생성된 것이다.  
	- 하나는 80%를 넘을 경우 인스턴스를 하나 늘리는 경보고, 다른 하나는 다시 CPU 사용률이 75% 미만으로 내려가는 경우 인스턴스를 하나 줄이는 경보다. 


## 애플리케이션 성능 관리 툴(APM, Application Performance Management)

APM 툴은 애플리케이션의 성능을 측정하기 위한 툴로 애플리케이션을 더 깊게 분석해서 애플리케이션 내에서 발생하는 문제의 원인을 최대한 빨리 찾을 수 있게 도와주는 툴이다.  

툴이 굉장히 많기 때문에 기능이나 범위, 본인의 언어와 프레임워크에 따라 신중한 선택이 필요하다.

기본적으로 APM 툴들이 제공하는 기능은 다음과 같다.  

- 요청과 트랜잭션에 대한 성능 측정 : 요청량부터 요청별로 얼마만큼의 시간이 걸렸고 시간이 소요된 부분이 어디인지 측정해준다.
- 애플리케이션 Memory, GC : 애플리케이션이 실행되고 있는 프로세스의 메모리를 분석해준다. 
	- 언어의 VM 내에서 GC가 얼마나 돌고 있는지, VM의 object allocation 등 메모리 사용량에 대한 정보도 분석해준다.
- 알림 : 에러, 성능 등 기준을 설정해놓으면 CloudWatch의 경보처럼 알림을 보내준다.
- 사용자 지정 지표 : 시스템적 에러가 아니라도 개발자가 측정하고자 하는 지표들은 따로 관리할 수 있다.

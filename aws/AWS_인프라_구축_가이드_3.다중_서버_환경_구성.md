# 3. 다중 서버 환경 구성
#TIL/aws

---

### AWS Auto Scaling 그룹을 이용한 다중 서버 구성

- AWS Auto Scaling 그룹
	- AWS에서 제공하는 자동 다중 서버 서비스
	- 같은 사양, 같은 환경, 같은 코드를 가지고 있는 똑같은 EC2 인스턴스들의 묶음
	- 인스턴스들이 같은 AMI를 통해 만들어진다.

1. 어떤 인스턴스를 선택해 만들지 정하고, 해당 인스턴스의 현재 환경(OS, 디스크 내용 등)을 스냅샷으로 생성해 AMI를 만든다.
2. AMI를 이용해 어떤 설정(사양, 보안 그룹, 네트워크 등)의 인스턴스를 띄울지 미리 정의해두는 `시작 템플릿`을 생성한다.
3. 이 시작 템플릿을 이용해 인스턴스를 실행할 Auto Scaling 그룹을 생성한다.

#### [실습] Auto Scaling 그룹 생성

- AMI를 만들기 전에 인스턴스를 stopped(중지) 상태로 변경한다.
	- 안전한 스냅샷 작업을 위해서이다.
- 시작 템플릿은 인스턴스를 자동으로 생성할 때 어떤 AMI를 기반으로 생성할 것인지, 서버 사양, 보안 그룹 등은 어떻게 할 것인지에 대한 설정을 미리 정의하는 것이다.
	- 그래서 EC2 인스턴스 생성하는 방식과 흡사하다.
- 서브넷 설정은 인스턴스를 어떤 네트워크 망에 띄울 것인지 정하는 것이다.
	- ap-northease-2a는 서울 리전의 a 가용 영역에, ap-northease-2c는 서울 리전의 c 가용 영역에 생성한다는 의미이다.
- 임의로 CPU 사용률을 높이기 위해 stress 애플리케이션을 사용했다.  

```
sudo yum install stress -y
stress --cpu 1 --timeout 600 // 600초 동안 1개의 CPU 사용량 최대로
```

### Elastic Load Balancing을 이용한 서버 트래픽 분산 관리

ELB는 로드 밸런서 역할을 하는 AWS 서비스다.  

AWS 같은 클라우드 서비스를 이용하지 않는다면 L4 스위치와 같은 장비를 직접 구매해야 하지만 AWS에서는 손쉽게 이 서버를 추가할 수 있다.  

- 대상 그룹 : 로드 밸런서가 요청을 전달할 서버들을 묶어둔 개념적인 그룹
- 상태 검사 : 로드 밸런서는 관리하는 서버 중 정상적으로 동작하는 서버에만 요청을 전달한다. 이 때 정상 동작을 확인하기 위해 상태 검사(Health Check) 과정을 거친다.  
	- 예를 들어 `GET /health` 라는 요청에 상태 200을 응답하도록 하고 체크하는 형태이다.
	- 서버에 물어보는 주기도 설정할 수 있고, 몇 번 연속으로 비정상 코드를 응답해야 비정상으로 볼 것인지, 혹은 반대로 몇 번 연속으로 정상 코드를 응답해야 정상 상태로 변경할 것인지도 설정할 수 있다.
	- nginx만 살아 있어도 정상이라고 판단해도 된다면 해당 경로의 요청을 nginx에서 처리해도 된다. 반대로 WS 뿐만 아니라 WAS에서까지 올바르게 실행중이어야만 한다면 애플리케이션에서 처리하도록 설정하면 된다.

#### [실습] Auto Scaling 그룹, 대상 그룹, 로드 밸런서 구성

### 장애 조치 아키텍처 구성

장애 조치는 일부 서버에 장애 발생 시 전체 시스템이 죽는 것이 아니라 예비 시스템이 즉시 요청을 처리해서 문제 없이 서비스가 돌아가게 하는 것이다.  

#### [실습] Auto Scaling 그룹과 로드 밸런서를 통한 장애 조치

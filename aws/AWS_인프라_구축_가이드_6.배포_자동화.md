# 6. 배포 자동화

## AWS IAM

AWS를 사용하는 사람들 각각에게 제한된 권한을 줄 때 사용한다.  

이 장의 주제인 Code Deploy에도 권한을 부여해야 하기 때문에 먼저 정리한다.  

- 권한 : AWS의 서비스나 자원에 어떤 작업을 할 수 있는지 명시해두는 규칙이다.
- 정책 : 권한들의 모음. 사용자나 그룹에 권한을 직접 적용할 수는 없고 권한들로 만든 정책을 적용해야 한다.
- 사용자 : AWS의 기능과 자원을 이용하는 객체. 사람일 수도 있고 프로그램일 수도 있다.
- 그룹 : 여러 사용자에게 공통으로 권한을 부여할 수 있게 만들어진 개념이다.
- 역할 : 특정 서비스에서 생성한 객체에 권한을 부여하는 데 사용된다.
- 인스턴스 프로파일 : 사용자가 사람을 구분하고 권한을 주기 위한 개념이었다면 인스턴스 프로파일은 EC2 인스턴스를 구분하고 권한을 주기 위한 개념이다.

## AWS CodeDeploy

배포 자동화 서비스.  복잡해보여도 결국 사람이 하는 일을 자동화해줄 뿐이다. 


### CodeDeploy 배포 과정

배포 절차는 다음과 같다.  

1. 개발한 애플리케이션 최상단 경로에 `AppSpec.yml` 이라는 파일을 추가한다.
	- 배포에 필요한 모든 절차를 적어둔 명세서이다.
2. CodeDeploy에 프로젝트의 특정 버전을 배포해 달라고 요청한다.
3. CodeDeploy는 배포를 진행할 EC2 인스턴스에 설치돼 있는 CodeDeploy Agent들과 통신하며 Agent들에게 요청받은 버전을 배포해 달라고 요청한다.
4. 요청 받은 Agent들은 코드 저장소에서 프로젝트 전체를 서버에 내려받는다. 그리고 AppSpec.yml 파일을 읽어 해당 파일에 적힌 절차대로 배포를 진행한다.
5. Agent는 배포를 진행한 후 CodeDeploy에게 성공/실패 등의 결과를 알려준다.


### 구성 요소

- CodeDeploy Agent : EC2 인스턴스에 설치되어 CodeDeploy의 명령을 기다리고 있는 프로그램이다. 실제로 배포를 수행하는 것은 Agent이기 때문에 반드시 EC2 인스턴스에 설치되어 있어야 한다.

- AppSpec.yml : Agent가 배포 명령을 받았을 때 어떻게 배포를 진행해야 하는지 적어둔 명세서 파일이다.
	- files : 다운 받은 프로젝트를 어느 경로로 이동시킬지 명시할 수 있다.
	- 배포 시 발생하는 다양한 생명주기마다 원하는 스크립트를 실행할 수 있게 Hook을 제공해준다.
		- 배포 시 사용하는 스크립트들은 AppSpec.yml과 함께 프로젝트 최상단에 scripts 등의 디렉터리를 만들어서 두면 관리하기 용이하다.

#### [실습] CodeDeploy로 현재 위치 배포 진행하기

1. CodeDeploy와 자동배포가 진행될 EC2 인스턴스에게 필요한 권한을 부여하기 위해 서비스 역할 생성
2. AMI 생성용 EC2 인스턴스에 CodeDeploy Agent 설치 및 환경 구성 작업
3. 해당 EC2 인스턴스로 새로운 AMI와 시작 템플릿 생성
4. 시작 템플릿을 이용해 Auto Scaling 그룹에 여러 대의 인스턴스를 실행한 뒤에 코드 배포


- EC2 인스턴스를 생성할 때 역할을 부여하기 위해서는 인스턴스 프로파일을 지정해 둬야 한다.
	- 역할을 생성할 때 EC2 서비스를 위한 역할로 생성하면 자동으로 인스턴스 프로파일도 생성된다.

- CodeDeploy로 배포할 수 있는 인스턴스의 조건
	- 올바른 권한을 가진 역할이 필요
	- CodeDeploy Agent 설치
	- 애플리케이션이 배포될 경로에 이미 저장돼 있는 파일이 없어야 한다.


# 5. 배포 과정
#TIL/aws

---

## 중단 배포 / 무중단 배포

- 무중단 배포라는 방법이 있음에도 중단 배포를 하는 이유
	- 무중단 배포가 큰 비용일 때
	- 애플리케이션 코드나 DB 스키마 등의 이유로 구버전과 신버전이 동시에 서비스되면 안 되는 경우
		- DB 스키마 - 데이터베이스 정합성이 깨질 수 있다.
		- 임시 테이블을 만들거나 해서 차이 값을 마이그레이션 해야 한다.


## 현재 위치 배포

무중단 배포를 하기 위한 기법의 하나로, 여러 대의 서버를 배포할 때 새롭게 서버를 생성하거나 줄이지 않고 배포하는 방법을 뜻한다.  

	1. 로드 밸런서를 통해 4개의 서버에 v1 버전으로 서비스 중이라고 가정하자.
	2. 이 중 2개의 서버에 로드 밸런서에서 보내는 요청을 끊고, v2로 버전업 한다.  
	3. 버전업한 v2 서버들을 다시 로드 밸런서에 등록하여 서비스한다.
	4. 나머지 두 서버도 마찬가지로 로드 밸런서에서 제외하고 v2 배포 후 다시 등록하여 서비스한다.

## 서버 단위의 블루/그린 배포

블루/그린 배포는 두 개의 그룹을 가지고 진행된다. 이 그룹은 대상 그룹이 될 수도 있고 Auto Scaling 그룹이 될 수도 있다.  

1. v1 버전의 그룹을 블루 그룹이라고 가정하자. 
2. 블루 그룹과 똑같은 수의 서버 인스턴스를 생성하고, v2를 반영한다. 이를 그린 그룹이라 하자.
3. v2 반영이 완료되면 로드밸런서에 등록하여 블루와 그린 그룹으로 모두 서비스한다.
4. 몇 시간 동안 모니터링해도 이슈가 없다면, 블루 그룹을 로드 밸런서에서 제외하고 인스턴스를 종료한다.

### 현재 위치 배포에 비해 블루/그린 배포가 가지는 장단점

1. 구, 신버전이 동시에 떠 있는 시간을 매우 짧게 처리할 수 있다.
2. 롤백을 굉장히 빨리할 수 있다.
	- 테스트 환경과 다르게 운영에서는 다른 이슈가 발생할 수도 있기 때문에 블루 그룹을 바로 종료하지 않고 일정 시간 모니터링 후에 종료한다.
3. 배포 과정에서 서비스하는 인스턴스의 수가 줄지 않으므로 요청량을 처리하는 데서 오는 장애 부담이 없다.
	- 배포 시 인스턴스의 수를 두 배로 늘려야 하므로 현재 위치 배포에 비해 단점이 될 수도 있다.

## 서버 내 블루/그린 배포

서버 단위의 블루/그린 배포는 로드 밸런서를 이용해 각 그룹으로 라우팅했다면, 서버 내 블루/그린 배포는 웹 서버를 이용해 각 포트로 라우팅하는 방식이다.  

- 문제가 있다면 웹 서버의 설정 변경을 통해 빠르게 롤백할 수 있다는 장점이 있다.
- 웹 서버의 설정을 변경하기 위해 웹 서버를 재시작하면 안 된다.
	- ex) nginx 에는 서비스 자체를 재시작하는 restart 명령어와 설정 파일을 리로드하는 reload 명령어가 있다.
		- reload 명령어를 사용하면 nginx에서 새로운 프로세스를 생성하고 기존 프로세스에서는 새로운 요청을 받지 않도록 처리한다.


#### [실습] 블루/그린 배포

1. 평소에는 정지해두고 AMI를 생성할 때만 사용하는 AMI 생성용 인스턴스를 시작한다.
2. 인스턴스에 접속해 Git으로 최신 버전의 v2 소스코드를 배포한다.
3. 배포 완료 후 인스턴스를 종료하고 해당 인스턴스로 새로운 AMI를 생성한다. 생성된 AMI로 시작 템플릿을 생성한다.
4. 이 새로 구성한 v2 시작 템플릿으로 블루 그룹과 똑같은 수의 그린 그룹 인스턴스들을 생성한다.
5. 로드 밸런서에 그린 그룹을 등록해서 블루, 그린 그룹의 인스턴스들이 모든 요청을 나눠서 처리하게 한다.
6. 문제가 없다면 블루 그룹을 로드 밸런서에서 제외한다.

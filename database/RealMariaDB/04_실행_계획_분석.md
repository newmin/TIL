# Real MariaDB - 04. 실행 계획 분석
#TIL/Database/RealMariaDB

---

## 개요

### 쿼리 실행 절차

MariaDB 서버에서 쿼리가 실행되는 과정은 크게 3가지이다.  

- 사용자의 쿼리를 파싱해서 MariaDB 서버가 이해할 수 있는 `SQL 파스 트리`를 만든다.
	- "SQL 파싱"이라고 하며, MariaDB 서버의 "SQL 파서" 모듈이 처리한다.
- 파스 트리를 확인하면서 어떤 테이블부터 읽고 어떤 인덱스를 이용해 테이블을 읽을지 선택한다.
	- "최적화 및 실행 계획 수립" 단계이며, MariaDB 서버의 "옵티마이저"에서 처리한다.
- 두 번째 단계에서 결정된 내용으로 스토리지 엔진으로부터 데이터를 가져온다.  
	- 스토리지 엔진이 데이터를 읽어오면, MariaDB 엔진에서는 스토리지 엔진으로부터 받은 레코드를 조인하거나 정렬하는 작업을 수행한다.


### 옵티마이저의 종류

옵티마이저는 두 가지 방법으로 나눌 수 있는데, 요즘은 대부분의 RDBMS가  `비용 기반 최적화` 방법을 사용한다.  

- 규칙 기반 최적화
	- 대상 테이블의 레코드 건수나 선택도 등을 고려하지 않고 옵티마이저에 내장된 우선순위에 따라 실행 계획을 수립하는 방식이다.
	- 현재는 거의 지원되지 않거나 업데이트 되지 않는 방식이다.
- 비용 기반 최적화
	- 쿼리를 처리하기 위한 여러 가지 가능한 방법을 만들고, 각 단위 작업의 비용(부하) 정보와 대상 테이블의 예측된 통계 정보를 이용해 각 실행 계획 별 비용을 산출한다.

결국 비용 기반 최적화에서 가장 중요한 것은 `통계 정보`다.  

---

## 실행 계획 분석

EXPLAIN 키워드로 쿼리의 실행 계획을 확인할 수 있다.  
표의 각 라인은 쿼리 문장에서 사용된 테이블의 개수만큼 출력되고, 위쪽부터 (id 칼럼의 값이 작은 쪽부터) 가장 먼저 접근한 테이블이라고 보면 된다.  

각 칼럼의 내용을 하나씩 살펴보자.  

### id 칼럼

단위 SELECT 별로 부여되는 식별자 값이다.

### select_type 칼럼

- SIMPLE
	- UNION이나 서브쿼리를 사용하지 않는 단순한 SELECT 쿼리인 경우
	- 반드시 하나만 존재한다.
- PRIMARY
	- UNION이나 서브 쿼리를 가지는 실행 계획에서 가장 바깥쪽에 있는 단위 쿼리의 타입이다.
- UNION
	- UNION으로 결합하는 단위 쿼리 가운데 첫 번째를 제외한 두 번째 이후 쿼리의 타입이다.
	- UNION 첫 번째 단위 쿼리는 UNION의 결과를 담을 임시 테이블을 만들기 때문에 DERIVED 타입으로 표시된다.
- DEPENDENT UNION
	- DEPENDENT는 UNION, UNION ALL로 결합된 단위 쿼리가 외부에 의해 영향을 받는 것을 의미한다.  
- UNION RESULT
	- 임시 테이블로 생성한 UNION의 결과를 나타내는 라인의 타입이다.
	- 실제 단위 쿼리는 아니기 때문에 별도로 id값은 부여되지 않는다.
- SUBQUERY
	- FROM 절 이외에서 사용되는 서브 쿼리만을 의미한다.
- DEPENDENT SUBQUERY
	- 서브 쿼리가 바깥쪽 SELECT 쿼리에서 정의된 칼럼을 사용하는 경우를 의미한다.
	- DEPENDENT 키워드는 외부 쿼리가 수행된 후 내부 쿼리가 수행되어야 하므로 처리 속도가 느리다.  
- DERIVED
	- 단위 SELECT 쿼리의 실행 결과를 메모리나 디스크에 임시 테이블로 생성하는 것을 의미한다.
	- MariaDB 5.2(MySQL 5.5) 이하에서는 서브 쿼리가 FROM 절에 사용된 경우 항상 DERIVED를 만들었지만, 그 이후 버전부터는 FROM절의 서브 쿼리를 외부 쿼리와 통합하는 형태의 최적화가 수행되기도 한다.
	- 하지만 아무리 최적화가 일어나더라도 조인으로 해결할 수 있는 경우라면 서브 쿼리 보다는 조인으로 해결하는 것이 가장 좋다.
- UNCACHEABLE SUBQUERY
	- 보통은 조건이 똑같은 서브 쿼리가 실행될 때는 캐싱을 한다.
		- SUBQUERY는 외부 영향을 받지 않으므로 캐싱해서 필요할 때 사용한다.
		- DEPENDENT SUBQUERY는 의존하는 바깥쪽 쿼리의 칼럼 단위로 캐싱해서 사용한다.
	- 서브 쿼리에 포함된 요소에 의해서 캐시 자체가 불가능한 경우에 해당 타입이 표시된다.
- UNCACHEABLE UNION
	- 위와 동일하게 캐시가 불가능한 경우의 UNION을 의미한다.
- MATERIALIZED
	- MariaDB 5.2 버전까지는 기준 테이블의 매 레코드마다 서브 쿼리를 읽어서 처리하는 형태였다.
	- 하지만 5.3 버전부터는 서브 쿼리의 내용을 임시 테이블로 구체화(Materialization)한 후, 임시 테이블과 기존 테이블을 조인하는 형태로 최적화한다.
- INSERT
	- MariaDB 10.0.5부터는 INSERT, UPDATE, DELETE 문장에 대해서도 실행 계획을 조회할 수 있게 되었다.



































# Real MySQL - 3. 아키텍처
#TIL/Database

---

## MySQL 아키텍처

### MySQL의 전체 구조

MySQL 서버는 크게 MySQL 엔진과 스토리지 엔진으로 구분해서 볼 수 있다.  

- MySQL 엔진 : 클라이언트로부터의 접속 및 쿼리 요청을 처리하는 커넥션 핸들러, SQL 파서 및 전처리기, 그리고 쿼리의 최적화된 실행을 위한 옵티마이저가 중심을 이룬다. 또한 성능 향상을 위해 캐시나 버퍼 풀과 같은 보조 저장소 기능이 포함돼 있다.  
- 스토리지 엔진 : 위의 MySQL 엔진이 쿼리 분석 및 최적화 등의 두뇌 활동을 담당하고, 실제 데이터를 디스크에 저장하거나 디스크에서 데이터를 읽어오는 부분은 스토리지 엔진이 처리한다.  
	- MySQL 서버에서 MySQL 엔진은 하나지만 스토리지 엔진은 여러 개를 동시에 사용할 수 있다.  
	- 'CREATE TABLE test_table (col1 INT, col2 INT) ENGINE = INNODB' 와 같은 식으로 테이블을 생성하면, 해당 테이블의 모든 CRUD 작업은 InnoDB 스토리지 엔진이 처리한다.  
- 핸들러 API : MySQL 엔진의 쿼리 실행기에서 데이터의 쓰기/읽기가 필요한 경우에는 스토리지 엔진에게 쓰기/읽기를 요청하는데, 이러한 요청을 핸들러 요청이라고 하고, 여기서 사용되는 API 를 핸들러 API 라고 한다.


### MySQL 스레딩 구조

MySQL 서버는 프로세스 기반이 아니라 스레드 기반으로 작동하며, 크게 포그라운드(Foreground) 스레드와 백그라운드(Background) 스레드로 구분할 수 있다.  

- 포그라운드 스레드 (클라이언트 스레드) : 최소 서버에 접속한 클라이언트의 수만큼 존재하며, 각 사용자가 요청한 쿼리 문장을 수행하는 역할을 갖고 있다.  
	- 사용자가 작업을 마치고 커넥션을 종료하면, 해당 커넥션을 담당하던 스레드는 스레드 캐시(Thread Pool)로 돌아가는데, 이 때 스레드 캐시에 일정 개수 이상의 대기 스레드가 있으면 해당 스레드는 종료시킨다.
	- thread_cache_size 가 해당 스레드 캐시의 스레드 수를 설정하는 값이다.
	- 데이터를 데이터 버퍼나 캐시로부터 가져오며, 해당 부분에 데이터가 없는 경우에는 디스크나 인덱스로부터 데이터를 읽어와서 작업을 처리한다.  
- 백그라운드 스레드 : InnoDB의 경우에는 여러 작업이 백그라운드로 처리된다.  
	- 인서트 버퍼를 병합하는 스레드, 로그를 디스크로 기록하는 스레드, InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드, 데이터를 버퍼로 읽어들이는 스레드, 잠금이나 데드락을 모니터링하는 스레드, 이 모든 것을 총괄하는 메인 스레드 등이 있다.
	- 가장 중요한 것은 로그 스레드와 버퍼의 데이터를 디스크로 내려쓰는 작업을 하는 쓰기 스레드이다.


### 메모리 할당 및 사용 구조

MySQL 에서 사용되는 메모리 공간은 크게 글로벌 메모리 영역과 로컬 메모리 영역으로 나눌 수 있다.  
글로벌 메모리 영역의 모든 메모리 공간은 MySQL 서버가 시작되면서 무조건 OS로부터 할당된다.  

- 글로벌 메모리 영역 : 클라이언트 스레드 수와 무관하게 일반적으로 하나의 메모리 공간만 할당된다.
- 로컬 메모리 영역 : 세션 메모리 영역이라고도 한다. 클라이언트 스레드가 쿼리를 처리하는 데 사용하는 메모리 영역이다.
	- 대표적으로 커넥션 버퍼와 소트(정렬) 버퍼가 있다.
	- 각 클라이언트 별로 독립적으로 할당된다.


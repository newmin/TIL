# Real MySQL - 17. 응급처치
#TIL/Database/RealMySQL

---

## 서버 과부하

### 프로세스 리스트 확인

MySQL의 "show processlist" 명령어를 통해 다양한 프로세스의 정보를 확인할 수 있다.  
확인할 수 있는 정보는 다음과 같다.  

- 현재 MySQL 서버에 존재하는 전체 프로세스 목록
- 각 프로세스가 어떤 작업(SQL)을 실행하고 있는지
- 각 작업의 현재 상태
- 각 작업의 실행 시간

결과 표의 한 레코드는 하나의 프로세스를 의미함과 동시에 하나의 커넥션을 의미한다.  
주의 깊게 봐야하는 항목은 Command 칼럼, Time 칼럼이며, 때때로 Info 칼럼에 출력되는 SQL도 도움이 된다.  

- Command가 "Sleep"이나 "Binlog Dump" 상태가 아닌 프로세스는 대부분 클라이언트의 요청으로 SQL을 실행하고 있음을 의미하는데, 이때 Time의 칼럼이 해당 작업을 몇 초 동안 실행하고 있는 지 알려준다.  
- 한 프로세스가 오래 실행된다면 State 칼럼을 확인하자. 주로 두 가지가 표시된다.
	- "Waiting ..." 일 때는 다른 프로세스가 선점하고 있는 잠금을 기다리는 것을 의미한다.
	- "Copy to tmp table" 일 때는 쿼리의 처리를 위해 내부적인 임시 테이블로 복사하는 작업이 실행되고 있음을 의미한다.
- 많은 프로세스가 Command 칼럼의 값이 모두 비슷하고 Info 칼럼에 똑같은 SQL이 표시될 때가 많다. 이는 최적화되지 못한 한 두개의 쿼리가 서버 부하를 일으킬 때 자주 나타난다.
- 프로세스 목록에 다양한 값의 Command와 State가 출력된다면, 이는 여러 개의 쿼리가 부하를 유발하고 있다는 뜻이므로 MySQL 서버 상의 외부적인 요인이 있는지 확인해보는 것이 좋다.  
- MySQL 서버 부하가 높은 편인데도 Command 칼럼이 대부분 "Sleep" 상태이고 Time 칼럼의 값이 0이라면 이는 MySQL 서버가 빠르게 처리되는 쿼리를 아주 빈번하게 처리하고 있음을 보여준다. 이 때는 쿼리 최적화가 잘 되어있지만 사용자의 수, 쿼리 요청이 증가한 것이므로 MySQL 서버의 확장을 고려하는 것이 좋다.


### 최대 커넥션 설정 확인

MySQL 서버에서 허용하는 최대 커넥션의 수를 너무 크게 설정했다면 MySQL 서버가 동시에 너무 많은 요청을 받아 제대로 처리하지 못하는 현상이 발생할 수 있다.  
이럴 때는 최대 허용 커넥션을 적절히 줄여서 MySQL 서버가 가능 범위 내에서 최대 요청을 처리할 수 있도록 해야 한다.  

반대로 너무 적은 커넥션 수를 설정해 서버의 처리 용량에 여유가 있다면 수를 더 늘리는 것이 좋다.  

"max_connections" 라는 시스템 설정 변수는 동적 변수이므로 MySQL 서버의 재시작 없이 즉시 적용할 수 있다.  






































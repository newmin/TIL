# Real MySQL - 10. 파티션
#TIL/Database

---

## 개요
파티션이란 MySQL 서버의 입장에서는 데이터를 별도의 테이블로 분리해서 저장하지만 사용자 입장에서는 논리적인 하나의 테이블로 사용할 수 있게 하는 기능을 의미한다.  


### 파티션을 사용하는 이유

- 하나의 테이블이 너무 커서 인덱스의 크기가 물리적인 메모리보다 훨씬 큰 경우 단일 INSERT나 SELECT를 빠르게 처리할 수 있다.
	- 파티션을 나누면 인덱스도 각각 생성되기 때문에 작은 인덱스 크기로 인해 메모리에서 빠르게 쿼리 작업을 진행할 수 있다.
- 데이터 특성 상 주기적인 삭제 작업이 필요한 경우 효율적으로 관리할 수 있다.
	- 로그 데이터가 대표적인 예시다.


### 파티션의 INSERT, UPDATE

- INSERT
	- INSERT 되는 칼럼 중 파티션 키인 칼럼을 이용해 파티션 표현식을 평가하고, 해당 파티션을 결정한다.
- UPDATE
	- WHERE 조건에 파티션 키가 존재한다면 해당 파티션을 바로 찾을 수 있으므로 빠르게 처리할 수 있다.
	- 하지만 WHERE 조건에 파티션 키가 없다면 모든 파티션을 검색해야 한다.
	- 파티션 키 이외의 칼럼만 변경할 때는 일반적인 경우와 같다.
	- 파티션 키 칼럼이 변경될 때는 기존 레코드 삭제, 변경되는 파티션 키 표현식 평가, 새로운 파티션에 데이터 저장 순으로 이루어진다.


### 파티션의 SELECT

조회의 경우에는 다음 두가지 조건을 고려해야 한다.

- WHERE 절의 조건으로 검색해야 할 파티션을 선택할 수 있는가?
- WHERE 절의 조건이 인덱스를 효율적으로 사용할 수 있는가? (인덱스 레인지 스캔)

두 번째 조건은 일반적인 경우에도 고려하는 조건이지만 첫 번째 조건과의 조합에 따라 결과가 달라진다.

- 파티션 선택 가능 + 인덱스 효율적 사용 가능
	- 파티션을 선택하여 해당 인덱스도 사용하는 가장 효율적인 경우이다.
- 파티션 선택 불가 + 인덱스 효율적 사용 가능
	- 파티션을 특정할 수 없기 때문에 모든 파티션을 대상으로 인덱스 레인지 스캔을 수행한다. 
	- 파티션의 수가 많을수록 서버 부하가 높아진다.
- 파티션 선택 가능 + 인덱스 효율적 사용 불가
	- 해당 파티션에서 풀 테이블 스캔을 한다. 파티션을 특정했지만 풀 테이블 스캔이라 비효율적이다.
- 파티션 선택 불가 + 인덱스 효율적 사용 불가
	- 모든 파티션에서 풀 테이블 스캔을 하는 가장 비효율적인 경우이다.


### 파티션의 인덱스 스캔과 정렬

MySQL의 **파티션 테이블에서 인덱스는 전부 로컬 인덱스**이다.  
모든 인덱스는 파티션 단위로 생성되며, 파티션에 관계없이 테이블 전체의 글로벌한 인덱스는 지원하지 않는다는 것을 의미한다.  

인덱스 레인지 스캔을 수행하는 쿼리가 여러 개의 파티션을 읽어야 할 때, 정렬은 어떻게 일어날까?  

```sql
SELECT * 
FROM sample_tbl
WHERE col_1 BETWEEN 'aaa' AND 'eee'
ORDER BY col_1;
```

sample_tbl 테이블에는 col_1 컬럼에 인덱스가 생성되어 있고, 파티션 되어있다고 가정하자.  
각 파티션에는 col_1 순서대로 인덱스가 존재하지만, 전체 파티션의 데이터를 보았을 때는 정렬된 상태가 아닐 것이다.  

이 때 이 쿼리의 실행계획을 확인해보면, 예상과 다르게 "Using Filesort" 코멘트가 없는 것을 볼 수 있다.  
전체로 보았을 때 정렬된 상태가 아니기 때문에 정렬을 수행할 것 같지만, 실제로는 그렇지 않다.  

MySQL 서버는 여러 파티션에 대해 인덱스 스캔을 수행할 때, 각 파티션으로부터 조건에 일치하는 레코드를 정렬된 순서대로 읽으면서 우선순위 큐(Priority Queue)에 임시로 저장한다.  
그리고 우선순위 큐에서 다시 필요한 순서대로 데이터를 가져가는 것이다.  
이는 각 파티션에 데이터가 이미 정렬된 상태로 존재하기 때문에 가능한 일이다.  

결론적으로 파티션 테이블에서 인덱스 스캔을 통해 레코드를 읽을 때 별도의 정렬 작업은 거치지 않고, 큐 처리만 한번 더 진행할 뿐이다.  


### 파티션 프루닝

최적화 단계에서 필요한 파티션만 골라내고 불필요한 파티션은 실행 계획에서 배제하여 전혀 접근하지 않는 것을 `파티션 프루닝`이라고 한다.  
파티션 프루닝에 관련된 실행 계획을 확인할 때에는 "EXPLAIN PARTITIONS" 명령을 사용해야 한다.  






























